<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>Grinch Mafia ‚Äî Host Tracker (Step-by-step)</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#121a33;
      --panel2:#0f162d;
      --line:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --accent:#8aa6ff;
      --good:#7bd389;
      --bad:#ff6b6b;
      --warn:#ffd166;

      --radius:16px;
      --shadow: 0 10px 28px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(138,166,255,.18), transparent 60%),
        radial-gradient(900px 600px at 80% 10%, rgba(123,211,137,.12), transparent 60%),
        radial-gradient(900px 600px at 50% 90%, rgba(255,107,107,.10), transparent 60%),
        var(--bg);
    }
    header{
      position:sticky; top:0; z-index:10;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(11,16,32,.92), rgba(11,16,32,.65));
      backdrop-filter: blur(10px);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:14px}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .title h1{margin:0;font-size:18px}
    .pills{display:flex;gap:8px;flex-wrap:wrap}
    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
    }
    .btns{display:flex;gap:8px;flex-wrap:wrap}
    button{
      cursor:pointer;
      border:none;
      border-radius:12px;
      padding:10px 12px;
      font-weight:800;
      font-size:12px;
      color:var(--text);
      background: linear-gradient(180deg, rgba(34,48,106,.95), rgba(26,37,80,.95));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 18px rgba(0,0,0,.22);
    }
    button.secondary{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:none;
      font-weight:700;
    }
    button.good{
      background: linear-gradient(180deg, rgba(123,211,137,.34), rgba(123,211,137,.16));
      border:1px solid rgba(123,211,137,.35);
    }
    button.danger{
      background: linear-gradient(180deg, rgba(255,107,107,.35), rgba(255,107,107,.16));
      border:1px solid rgba(255,107,107,.35);
    }
    button:disabled{opacity:.55;cursor:not-allowed}
    .grid{display:grid;grid-template-columns: 360px 1fr; gap:14px; align-items:start; padding-top:14px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(18,26,51,.92), rgba(15,22,45,.92));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:12px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .hd .h{font-weight:900;font-size:13px;color:rgba(255,255,255,.88)}
    .bd{padding:12px}
    .kpi{display:grid;grid-template-columns:1fr 1fr 1fr; gap:10px}
    .k{
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px;
    }
    .k .t{font-size:12px;color:var(--muted)}
    .k .v{font-family:var(--mono);font-size:22px;font-weight:900;margin-top:4px}
    .k .sub{font-size:11px;color:var(--muted);margin-top:6px;line-height:1.25}
    .tag{
      font-size:11px; padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:rgba(255,255,255,.86);
      display:inline-flex; gap:6px; align-items:center;
      white-space:nowrap;
    }
    .tag.good{border-color:rgba(123,211,137,.35)}
    .tag.bad{border-color:rgba(255,107,107,.35)}
    .tag.warn{border-color:rgba(255,209,102,.35)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .two{display:grid;grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:780px){ .two{grid-template-columns:1fr} }
    label{display:block;font-size:12px;color:var(--muted); margin:0 0 6px}
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:84px; resize:vertical}
    .mono{font-family:var(--mono)}
    .hint{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .hint b{color:rgba(255,255,255,.92)}
    .divider{height:1px;background:var(--line);margin:12px 0}

    /* Stepper */
    .stepHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      background: rgba(0,0,0,.16);
    }
    .stepHead .name{font-weight:950}
    .stepHead .sub{font-size:12px;color:var(--muted)}
    .step{
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      background: rgba(0,0,0,.14);
      overflow:hidden;
    }
    .step.active{border-color:rgba(138,166,255,.35)}
    .step .body{padding:12px; display:none}
    .step.active .body{display:block}
    .stepNav{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
      padding:10px 12px; border-top:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .warnText{color:var(--warn);font-size:12px;display:none;margin-top:8px;line-height:1.35}
    .warnText.show{display:block}
    .log{
      font-family:var(--mono);
      font-size:11px;
      line-height:1.35;
      white-space:pre-wrap;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px;
      max-height:260px;
      overflow:auto;
    }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(0,0,0,.55);
      padding:16px;
      z-index:50;
    }
    .modal.show{display:flex}
    .modal .box{
      width:100%; max-width:720px;
      background: linear-gradient(180deg, rgba(18,26,51,.98), rgba(12,18,36,.98));
      border:1px solid rgba(255,255,255,.14);
      border-radius: 20px;
      box-shadow: 0 30px 60px rgba(0,0,0,.5);
      overflow:hidden;
    }
    .modal .topBar{
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modal .big{font-size:18px;font-weight:950;margin:0 0 8px}
    .modal .content{padding:14px}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:14px;
      z-index:60;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 12px;
      border-radius:999px;
      color:rgba(255,255,255,.9);
      font-size:12px;
      display:none;
      backdrop-filter: blur(10px);
    }
    .toast.show{display:block}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <h1 id="uiTitle">Grinch Mafia ‚Äî Host Tracker</h1>
        <div class="pills">
          <span class="pill" id="uiPill1">Long Mode ‚Ä¢ 6‚Äì7 players ‚Ä¢ no night eliminations</span>
          <span class="pill" id="uiPill2">Auto win ‚Ä¢ +1 üéÅ/day cap ‚Ä¢ Step-by-step</span>
        </div>
      </div>
      <div class="btns">
        <button class="secondary" id="btnLang">RU</button>
        <button class="secondary" id="btnExport">Export log</button>
        <button class="danger" id="btnReset">New game</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap grid">
  <!-- LEFT: TRACKS + TIMER -->
  <div class="card" id="leftCard">
    <div class="hd">
      <div class="h" id="leftHead">Tracks + Timer</div>
      <div class="row" style="gap:8px">
        <span class="tag" id="tagSaved">Saved ‚úì</span>
        <span class="tag" id="tagState">Not started</span>
      </div>
    </div>
    <div class="bd">
      <div class="kpi">
        <div class="k">
          <div class="t" id="lblPresents">Presents üéÅ</div>
          <div class="v" id="kPresents">‚Äî</div>
          <div class="sub" id="subPresents">0‚Ä¶start (not above)</div>
        </div>
        <div class="k">
          <div class="t" id="lblHearts">Hearts ‚ù§Ô∏è</div>
          <div class="v" id="kHearts">‚Äî</div>
          <div class="sub" id="subHearts">0‚Ä¶8 (8 = win)</div>
        </div>
        <div class="k">
          <div class="t" id="lblDay">Day</div>
          <div class="v" id="kDay">‚Äî</div>
          <div class="sub" id="subDay">Win check at end of Day 6</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="stepHead">
        <div>
          <div class="name" id="capTitle">Presents cap</div>
          <div class="sub" id="capSub">Max +1 üéÅ per day from all sources</div>
        </div>
        <span class="tag warn" id="capTag">Today +üéÅ: ‚Äî</span>
      </div>

      <div class="divider"></div>

      <div class="stepHead" style="margin-bottom:10px">
        <div>
          <div class="name" id="timerTitle">Timer</div>
          <div class="sub"><span id="timerLeftLbl">Left:</span> <span class="mono" id="timerLeft">07:00</span></div>
        </div>
        <span class="tag" id="timerModeTag">‚Äî</span>
      </div>

      <label id="timerLabel">Timer (mm:ss)</label>
      <input id="timerInput" class="mono" value="07:00"/>

      <div class="btns" style="margin-top:10px">
        <button id="tStart">Start</button>
        <button class="secondary" id="tPause">Pause</button>
        <button class="secondary" id="tReset">Reset</button>
      </div>

      <div class="divider"></div>

      <label id="presetsLabel">Quick presets</label>
      <div class="btns">
        <button class="secondary" id="presetDiscuss">07:00</button>
        <button class="secondary" id="presetBark">00:30</button>
        <button class="secondary" id="presetTie">01:00</button>
        <button class="secondary" id="preset60">01:00</button>
        <button class="secondary" id="preset2m">02:00</button>
        <button class="secondary" id="preset5m">05:00</button>
      </div>

      <div class="hint" id="winHint"></div>
      <div class="btns" style="margin-top:10px">
        <button class="good" id="btnWinCheck">Check win now</button>
        <button class="secondary" id="btnUndo">Undo (1)</button>
      </div>
    </div>
  </div>

  <!-- RIGHT: STEPS -->
  <div class="card" id="rightCard">
    <div class="hd">
      <div class="h" id="rightHead">Step-by-step host flow</div>
      <div class="row" style="gap:8px">
        <span class="tag" id="tagStep">Step 1/7</span>
        <span class="tag good" id="tagMaxSide">Max: Bad</span>
        <span class="tag" id="tagBark">Bark: off</span>
      </div>
    </div>
    <div class="bd">
      <!-- STEP 1: SETUP -->
      <div class="step" id="step1">
        <div class="stepHead">
          <div>
            <div class="name" id="s1Title">1) Setup</div>
            <div class="sub" id="s1Sub">Players + (optional) roles for correct win logic</div>
          </div>
          <span class="tag" id="s1Tag">‚Äî</span>
        </div>
        <div class="body">
          <div class="two">
            <div>
              <label id="playersCountLbl">Players</label>
              <select id="playersCount">
                <option value="6">6</option>
                <option value="7">7</option>
              </select>
            </div>
            <div>
              <label id="playersNamesLbl">Names (comma-separated)</label>
              <input id="playersNames" placeholder="Anna, Peter, Maria..."/>
            </div>
          </div>

          <div class="divider"></div>

          <div class="two">
            <div>
              <label id="rolesModeLbl">Roles mode</label>
              <select id="rolesMode">
                <option value="known">Known to host (recommended)</option>
                <option value="unknown">Unknown / I don‚Äôt want roles here</option>
              </select>
              <div class="hint" id="rolesHint"></div>
            </div>
            <div>
              <label id="setupActionsLbl">Actions</label>
              <div class="btns">
                <button id="btnInit">Create game</button>
                <button class="secondary" id="btnAutoRoles">Auto-assign roles</button>
              </div>
              <div class="warnText" id="setupWarn">‚Äî</div>
            </div>
          </div>

          <div class="divider"></div>

          <div id="rolesBox" style="display:none">
            <div class="two">
              <div>
                <label id="rolesAssignLbl">Assign roles (host only)</label>
                <div class="small" id="rolesAssignTip"></div>
              </div>
              <div>
                <label>&nbsp;</label>
                <div class="btns">
                  <button class="secondary" id="btnClearRoles">Clear roles</button>
                </div>
              </div>
            </div>
            <div id="rolesTable" style="margin-top:10px"></div>
          </div>
        </div>
        <div class="stepNav">
          <button class="good" id="s1Next">Next ‚Üí Night</button>
        </div>
      </div>

      <div class="divider"></div>

      <!-- STEP 2: NIGHT -->
      <div class="step" id="step2">
        <div class="stepHead">
          <div>
            <div class="name" id="s2Title">2) Night</div>
            <div class="sub" id="s2Sub">Grinch ‚Üí Max ‚Üí Guard (steal affects üéÅ only)</div>
          </div>
          <span class="tag warn" id="s2Tag">‚Äî</span>
        </div>
        <div class="body">
          <div class="two">
            <div>
              <label id="grinchTargetLbl">Grinch: steal target</label>
              <select id="selGrinchTarget"></select>
            </div>
            <div>
              <label id="guardTargetLbl">Guard: protect (no same two nights)</label>
              <select id="selGuardTarget"></select>
              <div class="warnText" id="guardWarn">Guard repeated last night ‚Äî not allowed.</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="two">
            <div>
              <label id="maxTargetLbl">Max: target</label>
              <select id="selMaxTarget"></select>
            </div>
            <div>
              <label id="maxEffectLbl">Max: effect</label>
              <select id="selMaxEffect">
                <option value="ScentTrail">Scent Trail</option>
                <option value="Rumor">Rumor</option>
                <option value="BarkAlarm">Bark Alarm</option>
              </select>
              <div class="small" id="maxEffectHelp" style="margin-top:6px"></div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="btns">
            <button id="btnResolveNight">Resolve night</button>
            <button class="secondary" id="btnMaxSwitch">Max switches side (after Day 3)</button>
          </div>
          <div class="hint" id="nightExplain"></div>
        </div>
        <div class="stepNav">
          <button class="secondary" id="s2Prev">‚Üê Back</button>
          <button class="good" id="s2Next">Next ‚Üí Morning</button>
        </div>
      </div>

      <div class="divider"></div>

      <!-- STEP 3: MORNING -->
      <div class="step" id="step3">
        <div class="stepHead">
          <div>
            <div class="name" id="s3Title">3) Morning</div>
            <div class="sub" id="s3Sub">Announcement + Rumor / Bark Alarm</div>
          </div>
          <span class="tag" id="s3Tag">‚Äî</span>
        </div>
        <div class="body">
          <label id="morningTextLbl">Morning text</label>
          <textarea id="morningText" readonly></textarea>

          <div class="divider"></div>

          <div class="two">
            <div class="card" style="box-shadow:none">
              <div class="hd"><div class="h" id="rumorTitle">Rumor</div></div>
              <div class="bd">
                <div class="small" id="rumorLine">‚Äî</div>
                <div class="btns" style="margin-top:10px">
                  <button class="secondary" id="btnNewRumor">New rumor</button>
                </div>
              </div>
            </div>
            <div class="card" style="box-shadow:none">
              <div class="hd"><div class="h" id="barkTitle">Bark Alarm</div></div>
              <div class="bd">
                <div class="small" id="barkInfo">‚Äî</div>
                <div class="btns" style="margin-top:10px">
                  <button class="secondary" id="btnBarkSuccess">Success (+1 ‚ù§Ô∏è)</button>
                  <button class="secondary" id="btnBarkFail">Fail (0)</button>
                  <button class="secondary" id="btnSetBarkTimer">Set 00:30</button>
                </div>
                <div class="warnText" id="barkWarn">‚Äî</div>
              </div>
            </div>
          </div>
        </div>
        <div class="stepNav">
          <button class="secondary" id="s3Prev">‚Üê Back</button>
          <button class="good" id="s3Next">Next ‚Üí Day Event</button>
        </div>
      </div>

      <div class="divider"></div>

      <!-- STEP 4: DAY EVENT -->
      <div class="step" id="step4">
        <div class="stepHead">
          <div>
            <div class="name" id="s4Title">4) Day Event</div>
            <div class="sub" id="s4Sub">Draw 1 event, mark success/fail, apply</div>
          </div>
          <span class="tag" id="eventTag">‚Äî</span>
        </div>
        <div class="body">
          <div class="btns">
            <button id="btnDrawEvent">Draw event</button>
            <button class="secondary" id="btnRerollEvent">Reroll</button>
          </div>

          <div class="divider"></div>

          <div class="card" style="box-shadow:none">
            <div class="hd"><div class="h" id="eventName">‚Äî</div></div>
            <div class="bd">
              <div class="small" id="eventDesc">‚Äî</div>

              <div class="divider"></div>

              <div class="two">
                <div>
                  <label id="eventResultLbl">Result</label>
                  <select id="selEventResult">
                    <option value="none">Not decided</option>
                    <option value="success">Success</option>
                    <option value="fail">Fail</option>
                  </select>
                  <div class="warnText" id="eventCapWarn">Today üéÅ cap already used ‚Äî event üéÅ won‚Äôt be added.</div>
                </div>
                <div>
                  <label>&nbsp;</label>
                  <button id="btnApplyEvent">Apply event</button>
                  <div class="small" id="eventAppliedNote" style="margin-top:10px">‚Äî</div>
                </div>
              </div>

              <div class="hint" id="eventHint"></div>
            </div>
          </div>
        </div>
        <div class="stepNav">
          <button class="secondary" id="s4Prev">‚Üê Back</button>
          <button class="good" id="s4Next">Next ‚Üí Discussion</button>
        </div>
      </div>

      <div class="divider"></div>

      <!-- STEP 5: DISCUSSION + MAYOR -->
      <div class="step" id="step5">
        <div class="stepHead">
          <div>
            <div class="name" id="s5Title">5) Discussion</div>
            <div class="sub" id="s5Sub">Mayor protects 2 BEFORE discussion; discussion 07:00</div>
          </div>
          <span class="tag" id="s5Tag">‚Äî</span>
        </div>
        <div class="body">
          <div class="two">
            <div>
              <label id="mayorProtLbl">Mayor: protected from banishment (2)</label>
              <div class="row">
                <div style="flex:1;min-width:160px">
                  <select id="selMayorProt1"></select>
                </div>
                <div style="flex:1;min-width:160px">
                  <select id="selMayorProt2"></select>
                </div>
              </div>
              <div class="warnText" id="mayorWarn">Mayor repeated protection from yesterday ‚Äî not allowed.</div>
              <div class="btns" style="margin-top:10px">
                <button class="secondary" id="btnSaveMayor">Save protection</button>
                <button class="secondary" id="btnSetDiscussTimer">Set 07:00</button>
              </div>
              <div class="small" id="mayorSavedNote" style="margin-top:10px">‚Äî</div>
            </div>
            <div>
              <label id="cindyLbl">Cindy action</label>
              <button class="secondary" id="btnCindyKindness">Cindy: Kindness Round (1√ó)</button>
              <div class="small" id="cindyNote" style="margin-top:10px">‚Äî</div>
              <div class="hint" id="cindyHint"></div>
            </div>
          </div>
        </div>
        <div class="stepNav">
          <button class="secondary" id="s5Prev">‚Üê Back</button>
          <button class="good" id="s5Next">Next ‚Üí Vote</button>
        </div>
      </div>

      <div class="divider"></div>

      <!-- STEP 6: VOTE -->
      <div class="step" id="step6">
        <div class="stepHead">
          <div>
            <div class="name" id="s6Title">6) Vote</div>
            <div class="sub" id="s6Sub">Tie rules + banish + reveal alignment (alignment only)</div>
          </div>
          <span class="tag" id="s6Tag">‚Äî</span>
        </div>
        <div class="body">
          <div class="two">
            <div>
              <label id="tieLbl">Tie result</label>
              <select id="selTie">
                <option value="no">No tie</option>
                <option value="yes">Tie happened ‚Üí revote (no +1 ‚ù§Ô∏è for ‚Äúno tie‚Äù)</option>
                <option value="double">Tie twice ‚Üí no banishment (no +1 ‚ù§Ô∏è)</option>
              </select>
              <div class="btns" style="margin-top:10px">
                <button class="secondary" id="btnSetTieTimer">Set 01:00</button>
              </div>

              <div class="divider"></div>

              <label id="banishedLbl">Banished player</label>
              <select id="selBanished"></select>
              <div class="warnText" id="voteProtectedWarn">Cannot banish Mayor-protected player.</div>

              <div class="divider"></div>

              <label id="revealSideLbl">Host reveals alignment (for Hearts penalty)</label>
              <select id="selRevealSide">
                <option value="Good">Whoville (Good)</option>
                <option value="Bad">Grinch Team (Bad)</option>
              </select>

              <div class="divider"></div>

              <div id="grinchBanishedBox" style="display:none">
                <label>
                  <input type="checkbox" id="chkGrinchBanished"/>
                  <span id="grinchBanishedLbl">Grinch was banished (manual)</span>
                </label>
                <div class="small" id="grinchBanishedTip"></div>
              </div>

              <div class="btns" style="margin-top:10px">
                <button id="btnApplyVote">Apply vote</button>
              </div>

              <div class="small" id="voteNote" style="margin-top:10px">‚Äî</div>
            </div>

            <div>
              <div class="card" style="box-shadow:none">
                <div class="hd">
                  <div class="h" id="spiritTitle">Holiday Spirit (optional)</div>
                </div>
                <div class="bd">
                  <div class="small" id="spiritMeta">‚Äî</div>

                  <div class="divider"></div>

                  <label id="spiritWhoLbl">Who uses bonus</label>
                  <select id="selSpiritWho"></select>

                  <label id="spiritEffectLbl" style="margin-top:10px">Effect</label>
                  <select id="selSpiritEffect">
                    <option value="addHeart">+1 Heart</option>
                    <option value="cancelWrong">Cancel -1 Heart for wrong banishment</option>
                  </select>

                  <div class="btns" style="margin-top:10px">
                    <button class="secondary" id="btnUseSpirit">Use bonus</button>
                  </div>

                  <div class="small" id="spiritNote" style="margin-top:10px">‚Äî</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="stepNav">
          <button class="secondary" id="s6Prev">‚Üê Back</button>
          <button class="good" id="s6Next">Next ‚Üí End of Day</button>
        </div>
      </div>

      <div class="divider"></div>

      <!-- STEP 7: END OF DAY -->
      <div class="step" id="step7">
        <div class="stepHead">
          <div>
            <div class="name" id="s7Title">7) End of Day</div>
            <div class="sub" id="s7Sub">Apply Hearts checklist ‚Üí win check ‚Üí next day</div>
          </div>
          <span class="tag" id="s7Tag">‚Äî</span>
        </div>
        <div class="body">
          <div class="two">
            <div>
              <div class="card" style="box-shadow:none">
                <div class="hd"><div class="h" id="heartsChecklistTitle">Hearts checklist</div></div>
                <div class="bd" id="heartsChecks">
                  <label><input type="checkbox" id="chkCindyAlive"> <span id="lblCindyAlive">Cindy alive (+1 ‚ù§Ô∏è)</span></label>
                  <label><input type="checkbox" id="chkNoTie"> <span id="lblNoTie">Vote without tie (+1 ‚ù§Ô∏è)</span></label>
                  <label><input type="checkbox" id="chkEventHeart"> <span id="lblEventHeart">Day Event gave ‚ù§Ô∏è and succeeded (+1 ‚ù§Ô∏è)</span></label>
                  <label><input type="checkbox" id="chkWrongBanish"> <span id="lblWrongBanish">Wrong banishment: Good (-1 ‚ù§Ô∏è)</span></label>

                  <div class="divider"></div>

                  <button id="btnApplyEOD">Apply end of day</button>
                  <div class="small" id="eodPreview" style="margin-top:10px">‚Äî</div>
                </div>
              </div>
            </div>

            <div>
              <div class="card" style="box-shadow:none">
                <div class="hd"><div class="h" id="logHead">Game log</div></div>
                <div class="bd">
                  <div class="log" id="logBox">‚Äî</div>
                </div>
              </div>
            </div>
          </div>

          <div class="hint" id="rulesHint"></div>
        </div>
        <div class="stepNav">
          <button class="secondary" id="s7Prev">‚Üê Back</button>
          <button class="good" id="btnNextDay">Next day (go to Night)</button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- WIN MODAL -->
<div class="modal" id="winModal">
  <div class="box">
    <div class="topBar">
      <div class="tag" id="winModalTitle">Game over</div>
      <button class="secondary" id="btnCloseWin">Close</button>
    </div>
    <div class="content">
      <div class="big" id="winTitle">‚Äî</div>
      <div class="small" id="winReason">‚Äî</div>
      <div class="btns" style="margin-top:12px">
        <button class="danger" id="btnHardStop">Stop (lock UI)</button>
        <button class="secondary" id="btnNewGame2">New game</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast">‚Äî</div>

<script>
(() => {
  const LS_KEY = "grinch_mafia_step_tracker_v1";
  const $ = (id) => document.getElementById(id);

  // ---------- I18N (minimal, but clear) ----------
  const I18N = {
    ru:{
      uiTitle:"Grinch Mafia ‚Äî –¢—Ä–µ–∫–µ—Ä –≤–µ–¥—É—â–µ–≥–æ (–ø–æ—à–∞–≥–æ–≤–æ)",
      pill1:"Long Mode ‚Ä¢ 6‚Äì7 –∏–≥—Ä–æ–∫–æ–≤ ‚Ä¢ –±–µ–∑ –Ω–æ—á–Ω—ã—Ö –≤—ã–±—ã–≤–∞–Ω–∏–π",
      pill2:"–ê–≤—Ç–æ–ø–æ–±–µ–¥–∞ ‚Ä¢ –ª–∏–º–∏—Ç +1 üéÅ/–¥–µ–Ω—å ‚Ä¢ –æ–¥–∏–Ω —ç–∫—Ä–∞–Ω",
      leftHead:"–¢—Ä–µ–∫–∏ + –¢–∞–π–º–µ—Ä",
      rightHead:"–ü–æ—à–∞–≥–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –≤–µ–¥—É—â–µ–≥–æ",
      stateNotStarted:"–ù–µ –Ω–∞—á–∞—Ç–æ",
      stateRunning:"–ò–¥—ë—Ç",
      saved:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úì",
      capTitle:"–õ–∏–º–∏—Ç üéÅ",
      capSub:"–ú–∞–∫—Å–∏–º—É–º +1 üéÅ –∑–∞ –¥–µ–Ω—å –∏–∑ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤",
      timerTitle:"–¢–∞–π–º–µ—Ä",
      timerLeftLbl:"–û—Å—Ç–∞–ª–æ—Å—å:",
      timerLabel:"–¢–∞–π–º–µ—Ä (–º–º:—Å—Å)",
      presets:"–ü—Ä–µ—Å–µ—Ç—ã",
      export:"–≠–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–∞",
      newGame:"–ù–æ–≤–∞—è –∏–≥—Ä–∞",
      lang:"RU",
      winHint:"<b>Whoville:</b> ‚ù§Ô∏è=8 –ò–õ–ò Grinch –∏–∑–≥–Ω–∞–Ω –ø—Ä–∏ üéÅ‚â•6.<br><b>Grinch:</b> üéÅ=0 –ò–õ–ò –∫–æ–Ω–µ—Ü Day 6 –ø—Ä–∏ üéÅ‚â§3.<br><span class='small'>–ù–æ—á—å—é –Ω–∏–∫—Ç–æ –Ω–µ –≤—ã–±—ã–≤–∞–µ—Ç. –ù–æ—á—å –≤–ª–∏—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ üéÅ.</span>",
      checkWin:"–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–±–µ–¥—É —Å–µ–π—á–∞—Å",
      undo:"–û—Ç–∫–∞—Ç (1)",

      s1Title:"1) –°—Ç–∞—Ä—Ç",
      s1Sub:"–ò–≥—Ä–æ–∫–∏ + (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —Ä–æ–ª–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –ø–æ–±–µ–¥—ã",
      players:"–ò–≥—Ä–æ–∫–æ–≤",
      names:"–ò–º–µ–Ω–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)",
      rolesMode:"–†–µ–∂–∏–º —Ä–æ–ª–µ–π",
      rolesKnown:"–†–æ–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω—ã –≤–µ–¥—É—â–µ–º—É (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é)",
      rolesUnknown:"–†–æ–ª–∏ –Ω–µ —Ö–æ—á—É –≤–≤–æ–¥–∏—Ç—å",
      rolesHint:"–ï—Å–ª–∏ —Ä–æ–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω—ã ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–Ω–∏–º–∞–µ—Ç ¬´Grinch –∏–∑–≥–Ω–∞–Ω¬ª. –ï—Å–ª–∏ –Ω–µ –≤–≤–æ–¥–∏—Ç—å ‚Äî —Ç—ã –æ—Ç–º–µ—Ç–∏—à—å —ç—Ç–æ –≤—Ä—É—á–Ω—É—é –≤ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏.",
      create:"–°–æ–∑–¥–∞—Ç—å –ø–∞—Ä—Ç–∏—é",
      autoRoles:"–ê–≤—Ç–æ-—Ä–∞–∑–¥–∞—Ç—å —Ä–æ–ª–∏",
      clearRoles:"–û—á–∏—Å—Ç–∏—Ç—å —Ä–æ–ª–∏",
      rolesAssign:"–ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª–∏ (—Ç–æ–ª—å–∫–æ –≤–µ–¥—É—â–∏–π)",
      rolesAssignTip:"–†–æ–ª–∏ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–π –∏–≥—Ä–æ–∫–∞–º. –≠—Ç–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–±–µ–¥—ã –∏ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —á–µ–∫-–ª–∏—Å—Ç–æ–≤.",
      nextNight:"–î–∞–ª—å—à–µ ‚Üí –ù–æ—á—å",

      s2Title:"2) –ù–æ—á—å",
      s2Sub:"Grinch ‚Üí Max ‚Üí Guard (–∫—Ä–∞–∂–∞ –≤–ª–∏—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ üéÅ)",
      grinchTarget:"Grinch: —Ü–µ–ª—å –∫—Ä–∞–∂–∏",
      guardTarget:"Guard: –∑–∞—â–∏—Ç–∞ (–Ω–µ–ª—å–∑—è 2 –Ω–æ—á–∏ –ø–æ–¥—Ä—è–¥)",
      maxTarget:"Max: —Ü–µ–ª—å",
      maxEffect:"Max: —ç—Ñ—Ñ–µ–∫—Ç",
      maxHelp:"Scent Trail: Guard –Ω–µ —Å–ø–∞—Å—ë—Ç —Ü–µ–ª—å. Rumor: —É—Ç—Ä–æ–º —Å–ª—É—Ö (–Ω–µ —É–ª–∏–∫–∞). Bark: 30 —Å–µ–∫ —Ç–∏—à–∏–Ω—ã —É—Ç—Ä–æ–º (+1 ‚ù§Ô∏è –ø—Ä–∏ —É—Å–ø–µ—Ö–µ).",
      resolveNight:"–†–∞–∑—Ä–µ—à–∏—Ç—å –Ω–æ—á—å",
      maxSwitch:"Max –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç (–ø–æ—Å–ª–µ Day 3)",
      nightExplain:"–ê–ª–≥–æ—Ä–∏—Ç–º: –µ—Å–ª–∏ Guard –∑–∞—â–∏—â–∞–ª —Ü–µ–ª—å Grinch –ò Max –ù–ï —Å–¥–µ–ª–∞–ª Scent Trail –Ω–∞ —ç—Ç–æ–π —Ü–µ–ª–∏ ‚Üí –∫—Ä–∞–∂–∏ –Ω–µ—Ç. –ò–Ω–∞—á–µ –∫—Ä–∞–∂–∞ –µ—Å—Ç—å ‚Üí üéÅ -1.",

      s3Title:"3) –£—Ç—Ä–æ",
      s3Sub:"–û–±—ä—è–≤–ª–µ–Ω–∏–µ + Rumor / Bark Alarm",
      morningText:"–£—Ç—Ä–µ–Ω–Ω–∏–π —Ç–µ–∫—Å—Ç",
      rumor:"Rumor",
      newRumor:"–ù–æ–≤—ã–π —Å–ª—É—Ö",
      bark:"Bark Alarm",
      barkInfo:"–ï—Å–ª–∏ Bark –∞–∫—Ç–∏–≤–µ–Ω: 30 —Å–µ–∫—É–Ω–¥ —Ç–∏—à–∏–Ω—ã. –£—Å–ø–µ—Ö ‚Üí +1 ‚ù§Ô∏è (—Å—Ä–∞–∑—É —É—Ç—Ä–æ–º).",
      barkSuccess:"–£—Å–ø–µ—Ö (+1 ‚ù§Ô∏è)",
      barkFail:"–ü—Ä–æ–≤–∞–ª (0)",
      setBark:"–ü–æ—Å—Ç–∞–≤–∏—Ç—å 00:30",
      nextEvent:"–î–∞–ª—å—à–µ ‚Üí Day Event",

      s4Title:"4) Day Event",
      s4Sub:"–í—ã—Ç—è–Ω–∏ —Å–æ–±—ã—Ç–∏–µ, –æ—Ç–º–µ—Ç—å —É—Å–ø–µ—Ö/–ø—Ä–æ–≤–∞–ª, –ø—Ä–∏–º–µ–Ω—è–π",
      drawEvent:"–í—ã—Ç—è–Ω—É—Ç—å —Å–æ–±—ã—Ç–∏–µ",
      reroll:"–ü–µ—Ä–µ–≤—ã—Ç—è–Ω—É—Ç—å",
      eventResult:"–†–µ–∑—É–ª—å—Ç–∞—Ç",
      applyEvent:"–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ",
      eventHint:"–ü—Ä–∞–≤–∏–ª–æ: üéÅ-—Å–æ–±—ã—Ç–∏—è –Ω–µ –º–æ–≥—É—Ç –∏–¥—Ç–∏ 2 –¥–Ω—è –ø–æ–¥—Ä—è–¥ ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–≤—ã—Ç—è–≥–∏–≤–∞–µ—Ç. –õ–∏–º–∏—Ç: –º–∞–∫—Å–∏–º—É–º +1 üéÅ –≤ –¥–µ–Ω—å (—Å–æ–±—ã—Ç–∏–µ + Cindy –≤–º–µ—Å—Ç–µ).",
      nextDiscuss:"–î–∞–ª—å—à–µ ‚Üí –û–±—Å—É–∂–¥–µ–Ω–∏–µ",

      s5Title:"5) –û–±—Å—É–∂–¥–µ–Ω–∏–µ",
      s5Sub:"Mayor –≤—ã–±–∏—Ä–∞–µ—Ç 2 –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö –î–û –æ–±—Å—É–∂–¥–µ–Ω–∏—è; –æ–±—Å—É–∂–¥–µ–Ω–∏–µ 07:00",
      mayorProt:"Mayor: –∑–∞—â–∏—â–µ–Ω—ã (2)",
      saveProt:"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞—â–∏—Ç—É",
      setDiscuss:"–ü–æ—Å—Ç–∞–≤–∏—Ç—å 07:00",
      cindy:"–î–µ–π—Å—Ç–≤–∏–µ Cindy",
      kindness:"Cindy: Kindness Round (1√ó)",
      cindyHint:"Kindness –æ–±—ã—á–Ω–æ –¥–∞—ë—Ç +1 üéÅ, –ù–û –µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è —É–∂–µ –±—ã–ª +1 üéÅ (–æ—Ç Day Event), —Ç–æ–≥–¥–∞ –≤–º–µ—Å—Ç–æ üéÅ –¥–∞—ë—Ç—Å—è +1 ‚ù§Ô∏è.",
      nextVote:"–î–∞–ª—å—à–µ ‚Üí –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ",

      s6Title:"6) –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ",
      s6Sub:"–ù–∏—á—å–∏ + –∏–∑–≥–Ω–∞–Ω–∏–µ + —Ä–∞—Å–∫—Ä—ã—Ç—å —Ç–æ–ª—å–∫–æ —Å—Ç–æ—Ä–æ–Ω—É",
      tie:"–ù–∏—á—å—è",
      tieNo:"–ë–µ–∑ –Ω–∏—á—å–µ–π",
      tieYes:"–ë—ã–ª–∞ –Ω–∏—á—å—è ‚Üí –ø–µ—Ä–µ–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ (–Ω–µ—Ç +1 ‚ù§Ô∏è –∑–∞ ¬´–±–µ–∑ –Ω–∏—á—å–µ–π¬ª)",
      tieDouble:"–ù–∏—á—å—è –¥–≤–∞–∂–¥—ã ‚Üí –Ω–∏–∫–æ–≥–æ –Ω–µ –∏–∑–≥–æ–Ω—è–µ–º (–Ω–µ—Ç +1 ‚ù§Ô∏è)",
      setTie:"–ü–æ—Å—Ç–∞–≤–∏—Ç—å 01:00",
      banished:"–ò–∑–≥–Ω–∞–Ω–Ω—ã–π –∏–≥—Ä–æ–∫",
      reveal:"–û—Ç–∫—Ä—ã—Ç—å —Å—Ç–æ—Ä–æ–Ω—É (–¥–ª—è —à—Ç—Ä–∞—Ñ–∞ Hearts)",
      grinchBanished:"Grinch –∏–∑–≥–Ω–∞–Ω (–≤—Ä—É—á–Ω—É—é)",
      applyVote:"–ü—Ä–∏–º–µ–Ω–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ",
      voteNote:"–í–µ–¥—É—â–∏–π –æ–±—ä—è–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —Å—Ç–æ—Ä–æ–Ω—É: ‚ÄúWhoville (Good)‚Äù –∏–ª–∏ ‚ÄúGrinch Team (Bad)‚Äù. –†–æ–ª—å –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º.",
      spiritTitle:"Holiday Spirit (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)",
      spiritMeta:"–ò–∑–≥–Ω–∞–Ω–Ω—ã–π —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è ¬´–¥—É—Ö–æ–º¬ª. –ö–∞–∂–¥—ã–π –¥—É—Ö: 1 —Ä–∞–∑ –∑–∞ –∏–≥—Ä—É ‚Äî +1 ‚ù§Ô∏è –ò–õ–ò –æ—Ç–º–µ–Ω–∞ -1 ‚ù§Ô∏è –∑–∞ –æ—à–∏–±–∫—É.",
      spiritWho:"–ö—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–æ–Ω—É—Å",
      spiritEffect:"–≠—Ñ—Ñ–µ–∫—Ç",
      useBonus:"–ü—Ä–∏–º–µ–Ω–∏—Ç—å –±–æ–Ω—É—Å",
      nextEod:"–î–∞–ª—å—à–µ ‚Üí –ö–æ–Ω–µ—Ü –¥–Ω—è",

      s7Title:"7) –ö–æ–Ω–µ—Ü –¥–Ω—è",
      s7Sub:"–ß–µ–∫-–ª–∏—Å—Ç Hearts ‚Üí –ø–æ–±–µ–¥–∞ ‚Üí —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å",
      heartsChecklist:"Hearts —á–µ–∫-–ª–∏—Å—Ç",
      cindyAlive:"Cindy –∂–∏–≤–∞ (+1 ‚ù§Ô∏è)",
      noTie:"–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –±–µ–∑ –Ω–∏—á—å–µ–π (+1 ‚ù§Ô∏è)",
      eventHeart:"Day Event –¥–∞–ª ‚ù§Ô∏è –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω (+1 ‚ù§Ô∏è)",
      wrongBanish:"–û—à–∏–±–∫–∞: –∏–∑–≥–Ω–∞–ª–∏ Whoville (-1 ‚ù§Ô∏è)",
      applyEod:"–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–Ω–µ—Ü –¥–Ω—è",
      nextDay:"–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å (–∫ –ù–æ—á–∏)",
      log:"–õ–æ–≥",

      modalTitle:"–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞",
      close:"–ó–∞–∫—Ä—ã—Ç—å",
      stop:"–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å)",
      winNone:"–ü–æ–±–µ–¥—ã –Ω–µ—Ç",

      toastTime:"‚è∞ –í—Ä–µ–º—è!",
      guardRepeat:"Guard –ø–æ–≤—Ç–æ—Ä–∏–ª –∑–∞—â–∏—Ç—É –ø—Ä–æ—à–ª–æ–π –Ω–æ—á–∏ ‚Äî –Ω–µ–ª—å–∑—è.",
      mayorRepeat:"Mayor –ø–æ–≤—Ç–æ—Ä–∏–ª –∑–∞—â–∏—Ç—É –∫–∞–∫ –≤—á–µ—Ä–∞ ‚Äî –Ω–µ–ª—å–∑—è.",
      mayorNeedTwo:"Mayor –¥–æ–ª–∂–µ–Ω –≤—ã–±—Ä–∞—Ç—å 2 —Ä–∞–∑–Ω—ã—Ö –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –∂–∏–≤—ã—Ö ‚â• 2).",
      cannotBanishProtected:"–ù–µ–ª—å–∑—è –∏–∑–≥–Ω–∞—Ç—å –∑–∞—â–∏—â—ë–Ω–Ω–æ–≥–æ Mayor.",
      maxTooEarly:"Max –º–æ–∂–µ—Ç –ø–µ—Ä–µ–π—Ç–∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ Day 3.",
      maxAlready:"Max —É–∂–µ –ø–µ—Ä–µ—Ö–æ–¥–∏–ª.",
      kindnessUsed:"Kindness Round —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏.",
      needGame:"–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π –ø–∞—Ä—Ç–∏—é.",
      fillNight:"–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –Ω–æ—á–Ω—ã–µ –≤—ã–±–æ—Ä—ã.",
      spiritUsed:"–≠—Ç–æ—Ç –¥—É—Ö —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –±–æ–Ω—É—Å (1 —Ä–∞–∑ –∑–∞ –∏–≥—Ä—É).",
      spiritNoWrong:"–ù–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å -1 ‚ù§Ô∏è: —Å–µ–≥–æ–¥–Ω—è –Ω–µ –±—ã–ª–æ –æ—à–∏–±–æ—á–Ω–æ–≥–æ –∏–∑–≥–Ω–∞–Ω–∏—è (Good).",
    },
    en:{
      uiTitle:"Grinch Mafia ‚Äî Host Tracker (Step-by-step)",
      pill1:"Long Mode ‚Ä¢ 6‚Äì7 players ‚Ä¢ no night eliminations",
      pill2:"Auto win ‚Ä¢ +1 üéÅ/day cap ‚Ä¢ single screen",
      leftHead:"Tracks + Timer",
      rightHead:"Step-by-step host flow",
      stateNotStarted:"Not started",
      stateRunning:"Running",
      saved:"Saved ‚úì",
      capTitle:"Presents cap",
      capSub:"Max +1 üéÅ per day from all sources",
      timerTitle:"Timer",
      timerLeftLbl:"Left:",
      timerLabel:"Timer (mm:ss)",
      presets:"Presets",
      export:"Export log",
      newGame:"New game",
      lang:"EN",
      winHint:"<b>Whoville:</b> ‚ù§Ô∏è=8 OR Grinch banished while üéÅ‚â•6.<br><b>Grinch:</b> üéÅ=0 OR end of Day 6 with üéÅ‚â§3.<br><span class='small'>No night eliminations. Night affects üéÅ only.</span>",
      checkWin:"Check win now",
      undo:"Undo (1)",

      s1Title:"1) Setup",
      s1Sub:"Players + (optional) roles for correct win logic",
      players:"Players",
      names:"Names (comma-separated)",
      rolesMode:"Roles mode",
      rolesKnown:"Known to host (recommended)",
      rolesUnknown:"Unknown / don‚Äôt enter roles",
      rolesHint:"If roles are known, app can correctly detect ‚ÄúGrinch banished‚Äù. If unknown, you‚Äôll tick it manually in Vote step.",
      create:"Create game",
      autoRoles:"Auto-assign roles",
      clearRoles:"Clear roles",
      rolesAssign:"Assign roles (host only)",
      rolesAssignTip:"Do not show to players. Used only for win check & auto checklists.",
      nextNight:"Next ‚Üí Night",

      s2Title:"2) Night",
      s2Sub:"Grinch ‚Üí Max ‚Üí Guard (steal affects üéÅ only)",
      grinchTarget:"Grinch: steal target",
      guardTarget:"Guard: protect (no same two nights)",
      maxTarget:"Max: target",
      maxEffect:"Max: effect",
      maxHelp:"Scent Trail: Guard can‚Äôt save target. Rumor: morning line (not evidence). Bark: 30s silence (+1 ‚ù§Ô∏è on success).",
      resolveNight:"Resolve night",
      maxSwitch:"Max switches side (after Day 3)",
      nightExplain:"Logic: if Guard protected Grinch target AND Max did NOT use Scent Trail on that target ‚Üí no steal. Otherwise steal ‚Üí üéÅ -1.",

      s3Title:"3) Morning",
      s3Sub:"Announcement + Rumor / Bark Alarm",
      morningText:"Morning text",
      rumor:"Rumor",
      newRumor:"New rumor",
      bark:"Bark Alarm",
      barkInfo:"If Bark active: 30 seconds of silence. Success ‚Üí +1 ‚ù§Ô∏è (immediately in morning).",
      barkSuccess:"Success (+1 ‚ù§Ô∏è)",
      barkFail:"Fail (0)",
      setBark:"Set 00:30",
      nextEvent:"Next ‚Üí Day Event",

      s4Title:"4) Day Event",
      s4Sub:"Draw event, mark success/fail, apply",
      drawEvent:"Draw event",
      reroll:"Reroll",
      eventResult:"Result",
      applyEvent:"Apply event",
      eventHint:"Rule: üéÅ events cannot happen two days in a row ‚Äî app auto-rerolls. Cap: max +1 üéÅ per day total (event + Cindy).",
      nextDiscuss:"Next ‚Üí Discussion",

      s5Title:"5) Discussion",
      s5Sub:"Mayor protects 2 BEFORE discussion; discussion 07:00",
      mayorProt:"Mayor: protected (2)",
      saveProt:"Save protection",
      setDiscuss:"Set 07:00",
      cindy:"Cindy action",
      kindness:"Cindy: Kindness Round (1√ó)",
      cindyHint:"Kindness normally gives +1 üéÅ, BUT if a Day Event already gave +1 üéÅ today, then it gives +1 ‚ù§Ô∏è instead.",
      nextVote:"Next ‚Üí Vote",

      s6Title:"6) Vote",
      s6Sub:"Tie rules + banish + reveal alignment only",
      tie:"Tie result",
      tieNo:"No tie",
      tieYes:"Tie happened ‚Üí revote (no +1 ‚ù§Ô∏è for ‚Äúno tie‚Äù)",
      tieDouble:"Tie twice ‚Üí no banishment (no +1 ‚ù§Ô∏è)",
      setTie:"Set 01:00",
      banished:"Banished player",
      reveal:"Reveal alignment (for Hearts penalty)",
      grinchBanished:"Grinch banished (manual)",
      applyVote:"Apply vote",
      voteNote:"Host reveals alignment only: ‚ÄúWhoville (Good)‚Äù or ‚ÄúGrinch Team (Bad)‚Äù. No role reveal.",
      spiritTitle:"Holiday Spirit (optional)",
      spiritMeta:"Banished player becomes a Spirit. Each spirit once per game: +1 ‚ù§Ô∏è OR cancel -1 ‚ù§Ô∏è for wrong banishment.",
      spiritWho:"Who uses bonus",
      spiritEffect:"Effect",
      useBonus:"Use bonus",
      nextEod:"Next ‚Üí End of Day",

      s7Title:"7) End of Day",
      s7Sub:"Hearts checklist ‚Üí win ‚Üí next day",
      heartsChecklist:"Hearts checklist",
      cindyAlive:"Cindy alive (+1 ‚ù§Ô∏è)",
      noTie:"Vote without tie (+1 ‚ù§Ô∏è)",
      eventHeart:"Day Event gave ‚ù§Ô∏è and succeeded (+1 ‚ù§Ô∏è)",
      wrongBanish:"Wrong banishment: Good (-1 ‚ù§Ô∏è)",
      applyEod:"Apply end of day",
      nextDay:"Next day (to Night)",
      log:"Game log",

      modalTitle:"Game over",
      close:"Close",
      stop:"Stop (lock UI)",
      winNone:"No win yet",

      toastTime:"‚è∞ Time!",
      guardRepeat:"Guard repeated last night ‚Äî not allowed.",
      mayorRepeat:"Mayor repeated yesterday ‚Äî not allowed.",
      mayorNeedTwo:"Mayor must pick 2 different protected players (if alive ‚â• 2).",
      cannotBanishProtected:"Cannot banish Mayor-protected player.",
      maxTooEarly:"Max can switch only after Day 3.",
      maxAlready:"Max already switched.",
      kindnessUsed:"Kindness Round already used.",
      needGame:"Create game first.",
      fillNight:"Fill all night choices.",
      spiritUsed:"This spirit already used their one-time bonus.",
      spiritNoWrong:"Cannot cancel -1 ‚ù§Ô∏è: no wrong banishment today (Good).",
    }
  };

  function getLang(){
    const saved = localStorage.getItem(LS_KEY + ":lang");
    if(saved === "ru" || saved === "en") return saved;
    return "ru";
  }
  let lang = getLang();
  function t(key){ return (I18N[lang] && I18N[lang][key]) || key; }

  // ---------- Game state ----------
  const DEFAULT_STATE = () => ({
    started:false,
    locked:false,
    step:1,                 // 1..7
    playersCount:6,
    players:[],              // {name, role, alive, spiritUsed}
    rolesMode:"known",        // known/unknown
    startPresents:10,
    presents:10,
    hearts:0,
    day:1,

    // day flags
    presentGainedToday:false,

    // night picks
    night:{ grinch:null, guard:null, maxTarget:null, maxEffect:"Rumor" },
    lastGuard:null,

    // max
    maxSide:"Bad",           // Bad until switch
    maxSwitched:false,

    // morning effects status
    barkActive:false,
    barkResolved:false,
    rumorActive:false,
    rumorText:"",

    // day event
    currentEvent:null,       // event object
    lastEventType:null,       // "present"/"heart"/"mechanic" (previous day applied)
    eventApplied:false,
    eventResult:"none",

    // mayor
    mayorProt:[null,null],
    mayorLastProt:[null,null],
    mayorSaved:false,

    // vote
    tie:"no",                // no/yes/double
    banished:null,
    revealSide:"Good",
    wrongBanishToday:false,
    grinchBanishedToday:false, // computed or manual

    // spirit (day-level effect only)
    spiritCanceledWrong:false,

    // Cindy
    cindyKindnessUsed:false,

    // log + undo
    log:[],
    undo:null
  });

 let state = loadState() || DEFAULT_STATE();
state.undo = null;


 function saveState(){
  try{
    const { undo, ...persist } = state;              // –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º undo
    localStorage.setItem(LS_KEY, JSON.stringify(persist));
    $('tagSaved').textContent = t('saved');
  }catch(e){
    console.error(e);
    $('tagSaved').textContent = "NOT saved";
    toast(lang==="ru" ? "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å (–ø–∞–º—è—Ç—å –±—Ä–∞—É–∑–µ—Ä–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞)" : "Save failed (storage full)");
  }
}

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      return obj;
    }catch(e){ return null; }
  }

  // ---------- Toast ----------
  let toastTimer=null;
  function toast(msg){
    const el = $('toast');
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>el.classList.remove('show'), 1400);
  }

  // ---------- Helpers ----------
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const byAlive = (p)=>p.alive;
  const fmt = (n)=>String(n).padStart(2,'0');
  function parseMMSS(s){
    const m = String(s||"").trim().match(/^(\d{1,2}):(\d{2})$/);
    if(!m) return null;
    const mm = parseInt(m[1],10);
    const ss = parseInt(m[2],10);
    if(Number.isNaN(mm)||Number.isNaN(ss)||ss>59) return null;
    return mm*60 + ss;
  }
  function mmss(total){
    total = Math.max(0, Math.floor(total));
    const mm = Math.floor(total/60);
    const ss = total%60;
    return `${fmt(mm)}:${fmt(ss)}`;
  }
  function addLog(line){
    const stamp = `D${state.day} ‚Ä¢ ${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
    state.log.unshift(`${stamp} ‚Äî ${line}`);
    if(state.log.length>250) state.log.pop();
  }
 function setUndo(){
  const snap = JSON.parse(JSON.stringify(state));
  snap.undo = null;                 // –∫—Ä–∏—Ç–∏—á–Ω–æ: –Ω–µ –≤–∫–ª–∞–¥—ã–≤–∞–µ–º undo –≤ undo
  state.undo = JSON.stringify(snap);
}
  function doUndo(){
    if(!state.undo){ toast(t('winNone')); return; }
    try{
      state = JSON.parse(state.undo);
      state.undo = null;
      saveState();
      render();
      toast(t('undo'));
    }catch(e){}
  }

  // ---------- Events deck (24) ----------
  const EVENTS = [
    // üéÅ 1..6
    {id:1,type:"present",
      name:{ru:"Snowstorm üéÅ", en:"Snowstorm üéÅ"},
      text:{ru:"–û–±—Å—É–∂–¥–µ–Ω–∏–µ –∫–æ—Ä–æ—á–µ –Ω–∞ 2 –º–∏–Ω—É—Ç—ã (–ø–æ—Å—Ç–∞–≤—å 05:00).", en:"Shorten discussion by 2 minutes (set 05:00)."},
      onSuccess:{present:+1}, onFail:{}},
    {id:2,type:"present",
      name:{ru:"Gift Wrap Challenge üéÅ‚ö†Ô∏è", en:"Gift Wrap Challenge üéÅ‚ö†Ô∏è"},
      text:{ru:"60 —Å–µ–∫ –±–µ–∑ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–π (1 –æ–≥–æ–≤–æ—Ä–∫–∞ –¥–æ–ø—É—Å—Ç–∏–º–∞). –£—Å–ø–µ—Ö: +1 üéÅ, –ø—Ä–æ–≤–∞–ª: -1 ‚ù§Ô∏è.", en:"60s no interruptions (1 slip ok). Success: +1 üéÅ, fail: -1 ‚ù§Ô∏è."},
      onSuccess:{present:+1}, onFail:{heart:-1}},
    {id:3,type:"present",
      name:{ru:"Kindness Round üéÅ", en:"Kindness Round üéÅ"},
      text:{ru:"–ü–æ –∫—Ä—É–≥—É 10‚Äì15 —Å–µ–∫ –¥–æ–±—Ä–æ–π —Ñ—Ä–∞–∑—ã, –±–µ–∑ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–π. –£—Å–ø–µ—Ö: +1 üéÅ (–ª–∏–º–∏—Ç).", en:"Round of kind lines. Success: +1 üéÅ (cap)."},
      onSuccess:{present:+1}, onFail:{}},
    {id:4,type:"present",
      name:{ru:"Repair the Sleigh üéÅ‚ö†Ô∏è", en:"Repair the Sleigh üéÅ‚ö†Ô∏è"},
      text:{ru:"3 –∏–¥–µ–∏ –∑–∞ 60 —Å–µ–∫. –ù–µ –Ω–∞–±—Ä–∞–ª–∏ 3 ‚Äî –ø—Ä–æ–≤–∞–ª (-1 ‚ù§Ô∏è). –£—Å–ø–µ—Ö: +1 üéÅ.", en:"3 ideas in 60s. Fail: -1 ‚ù§Ô∏è. Success: +1 üéÅ."},
      onSuccess:{present:+1}, onFail:{heart:-1}},
    {id:5,type:"present",
      name:{ru:"Found Gift üéÅ", en:"Found Gift üéÅ"},
      text:{ru:"–°–ª—É—á–∞–π–Ω—ã–π –∏–≥—Ä–æ–∫ 20 —Å–µ–∫: ¬´–∫–æ–º—É –±—ã –ø–æ–¥–∞—Ä–∏–ª –∏ –ø–æ—á–µ–º—É¬ª. –£—Å–ø–µ—Ö: +1 üéÅ (–ª–∏–º–∏—Ç).", en:"Random player 20s. Success: +1 üéÅ (cap)."},
      onSuccess:{present:+1}, onFail:{}},
    {id:6,type:"present",
      name:{ru:"Town Cleanup üéÅ", en:"Town Cleanup üéÅ"},
      text:{ru:"2 –º–∏–Ω—É—Ç—ã –≥–æ–≤–æ—Ä–∏—Ç —Ç–æ–ª—å–∫–æ —Ç–æ—Ç, —É –∫–æ–≥–æ ¬´–º–∏–∫—Ä–æ—Ñ–æ–Ω¬ª. –£—Å–ø–µ—Ö: +1 üéÅ.", en:"2 minutes: only mic holder talks. Success: +1 üéÅ."},
      onSuccess:{present:+1}, onFail:{}},

    // ‚ù§Ô∏è 7..18
    {id:7,type:"heart", name:{ru:"Town Choir ‚ù§Ô∏è", en:"Town Choir ‚ù§Ô∏è"},
      text:{ru:"1 –º–∏–Ω—É—Ç–∞ –±–µ–∑ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–π. –£—Å–ø–µ—Ö: +1 ‚ù§Ô∏è.", en:"1 minute no interruptions. Success: +1 ‚ù§Ô∏è."},
      onSuccess:{heart:+1}, onFail:{}},
    {id:8,type:"heart", name:{ru:"Turn-Taking ‚ù§Ô∏è", en:"Turn-Taking ‚ù§Ô∏è"},
      text:{ru:"–ö–∞–∂–¥–æ–º—É –ø–æ 30 —Å–µ–∫ (–≤ —Å—É–º–º–µ ~5 –º–∏–Ω—É—Ç). –£—Å–ø–µ—Ö: +1 ‚ù§Ô∏è.", en:"30s each (~5 min total). Success: +1 ‚ù§Ô∏è."},
      onSuccess:{heart:+1}, onFail:{}},
    {id:9,type:"heart", name:{ru:"Whisper Round ‚ù§Ô∏è", en:"Whisper Round ‚ù§Ô∏è"},
      text:{ru:"2 –º–∏–Ω—É—Ç—ã –≤—Å–µ –≥–æ–≤–æ—Ä—è—Ç —à—ë–ø–æ—Ç–æ–º. –£—Å–ø–µ—Ö: +1 ‚ù§Ô∏è.", en:"2 minutes whisper-only. Success: +1 ‚ù§Ô∏è."},
      onSuccess:{heart:+1}, onFail:{}},
    {id:10,type:"heart", name:{ru:"Secret Vote ‚ù§Ô∏è", en:"Secret Vote ‚ù§Ô∏è"},
      text:{ru:"–ü—Ä–æ–±–Ω–æ–µ —Ç–∏—Ö–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ. –£—Å–ø–µ—Ö: +1 ‚ù§Ô∏è.", en:"Practice secret vote. Success: +1 ‚ù§Ô∏è."},
      onSuccess:{heart:+1}, onFail:{}},
    {id:11,type:"heart", name:{ru:"No-Accusation Minute ‚ù§Ô∏è", en:"No-Accusation Minute ‚ù§Ô∏è"},
      text:{ru:"60 —Å–µ–∫ –±–µ–∑ –ø—Ä—è–º—ã—Ö –æ–±–≤–∏–Ω–µ–Ω–∏–π. –£—Å–ø–µ—Ö: +1 ‚ù§Ô∏è.", en:"60s no direct accusations. Success: +1 ‚ù§Ô∏è."},
      onSuccess:{heart:+1}, onFail:{}},
    {id:12,type:"heart", name:{ru:"One-Sentence Rule ‚ù§Ô∏è", en:"One-Sentence Rule ‚ù§Ô∏è"},
      text:{ru:"2 –º–∏–Ω—É—Ç—ã: –∫–∞–∂–¥–∞—è —Ä–µ–ø–ª–∏–∫–∞ ‚Äî 1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. –£—Å–ø–µ—Ö: +1 ‚ù§Ô∏è.", en:"2 minutes: one sentence per turn. Success: +1 ‚ù§Ô∏è."},
      onSuccess:{heart:+1}, onFail:{}},
    {id:13,type:"heart", name:{ru:"Apology Token ‚ù§Ô∏è", en:"Apology Token ‚ù§Ô∏è"},
      text:{ru:"–ö—Ç–æ-—Ç–æ –ø—Ä–∏–∑–Ω–∞—ë—Ç —Å–æ–º–Ω–µ–Ω–∏–µ/–æ—à–∏–±–∫—É. –£—Å–ø–µ—Ö: +1 ‚ù§Ô∏è.", en:"Someone admits doubt/mistake. Success: +1 ‚ù§Ô∏è."},
      onSuccess:{heart:+1}, onFail:{}},
    {id:14,type:"heart", name:{ru:"Warm Welcome ‚ù§Ô∏è", en:"Warm Welcome ‚ù§Ô∏è"},
      text:{ru:"–ö–æ–º–ø–ª–∏–º–µ–Ω—Ç –ø—Ä–æ –ª–æ–≥–∏–∫—É/–¥–µ–π—Å—Ç–≤–∏—è. –£—Å–ø–µ—Ö: +1 ‚ù§Ô∏è.", en:"Compliment logic/actions. Success: +1 ‚ù§Ô∏è."},
      onSuccess:{heart:+1}, onFail:{}},
    {id:15,type:"heart", name:{ru:"Mayor‚Äôs Order ‚ù§Ô∏è", en:"Mayor‚Äôs Order ‚ù§Ô∏è"},
      text:{ru:"Mayor –æ–±—ä—è—Å–Ω—è–µ—Ç –∑–∞—â–∏—Ç—É 1 —Ñ—Ä–∞–∑–æ–π. –£—Å–ø–µ—Ö: +1 ‚ù§Ô∏è.", en:"Mayor explains protection in 1 line. Success: +1 ‚ù§Ô∏è."},
      onSuccess:{heart:+1}, onFail:{}},
    {id:16,type:"heart", name:{ru:"Guard‚Äôs Oath ‚ù§Ô∏è", en:"Guard‚Äôs Oath ‚ù§Ô∏è"},
      text:{ru:"Guard –æ–±–µ—â–∞–µ—Ç –∑–∞—â–∏—Ç–∏—Ç—å ¬´—Å–∞–º–æ–≥–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ¬ª. –£—Å–ø–µ—Ö: +1 ‚ù§Ô∏è.", en:"Guard vows to protect ‚Äòmost suspicious‚Äô. Success: +1 ‚ù§Ô∏è."},
      onSuccess:{heart:+1}, onFail:{}},
    {id:17,type:"heart", name:{ru:"Silent Start ‚ù§Ô∏è", en:"Silent Start ‚ù§Ô∏è"},
      text:{ru:"30 —Å–µ–∫ —Ç–∏—à–∏–Ω—ã. –£—Å–ø–µ—Ö: +1 ‚ù§Ô∏è.", en:"30 seconds silence. Success: +1 ‚ù§Ô∏è."},
      onSuccess:{heart:+1}, onFail:{}},
    {id:18,type:"heart", name:{ru:"Two Questions Only ‚ù§Ô∏è", en:"Two Questions Only ‚ù§Ô∏è"},
      text:{ru:"–ö–∞–∂–¥–æ–º—É –º–∞–∫—Å–∏–º—É–º 2 –≤–æ–ø—Ä–æ—Å–∞. –£—Å–ø–µ—Ö: +1 ‚ù§Ô∏è.", en:"Max 2 questions per player. Success: +1 ‚ù§Ô∏è."},
      onSuccess:{heart:+1}, onFail:{}},

    // mechanics 19..24
    {id:19,type:"mechanic", name:{ru:"Evidence Token", en:"Evidence Token"},
      text:{ru:"–í–µ–¥—É—â–∏–π –¥–∞—ë—Ç 1 –æ–±—â—É—é –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É (–±–µ–∑ —Ü–µ–ª–µ–π).", en:"Host gives 1 global neutral clue (no target)."},
      onSuccess:{}, onFail:{}},
    {id:20,type:"mechanic", name:{ru:"Gift Audit ‚ö†Ô∏è", en:"Gift Audit ‚ö†Ô∏è"},
      text:{ru:"–ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –∏–∑–≥–Ω–∞–ª–∏ Whoville (–æ—à–∏–±–∫–∞) ‚Üí –¥–æ–ø. -1 üéÅ –≤ –∫–æ–Ω—Ü–µ –¥–Ω—è.", en:"If wrong banish today (Good) ‚Üí extra -1 üéÅ at end of day."},
      onSuccess:{}, onFail:{}},
    {id:21,type:"mechanic", name:{ru:"Spotlight", en:"Spotlight"},
      text:{ru:"1 –∏–≥—Ä–æ–∫ –≥–æ–≤–æ—Ä–∏—Ç 30 —Å–µ–∫, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–æ–ª—á–∞—Ç.", en:"1 player speaks 30s, others silent."},
      onSuccess:{}, onFail:{}},
    {id:22,type:"mechanic", name:{ru:"Double Vote", en:"Double Vote"},
      text:{ru:"–†–∞–∑—Ä–µ—à–∏ 2 —Ç—É—Ä–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –º–µ–∂–¥—É –ª–∏–¥–µ—Ä–∞–º–∏.", en:"Allow 2 vote rounds between leaders."},
      onSuccess:{}, onFail:{}},
    {id:23,type:"mechanic", name:{ru:"Open Hands", en:"Open Hands"},
      text:{ru:"–†—É–∫–∏ –Ω–∞ —Å—Ç–æ–ª–µ. –£–º–µ–Ω—å—à–∞–µ—Ç –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏—è.", en:"Hands on table. Reduces interruptions."},
      onSuccess:{}, onFail:{}},
    {id:24,type:"mechanic", name:{ru:"Holiday Spirit Assist", en:"Holiday Spirit Assist"},
      text:{ru:"–†–∞–∑—Ä–µ—à–∏ –¥—É—Ö—É –ø—Ä–∏–º–µ–Ω–∏—Ç—å 1-—Ä–∞–∑–æ–≤—ã–π –±–æ–Ω—É—Å (–µ—Å–ª–∏ –µ—â—ë –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω).", en:"Allow Spirit to use their one-time bonus (if unused)."},
      onSuccess:{}, onFail:{}},
  ];

  const RUMORS = [
    {ru:"–•–æ–¥—è—Ç —Å–ª—É—Ö–∏, —á—Ç–æ {X} –∫—Ä—É—Ç–∏–ª—Å—è —Ä—è–¥–æ–º —Å –ø–æ–¥–∞—Ä–∫–∞–º–∏‚Ä¶ –Ω–æ —ç—Ç–æ —Ç–æ–ª—å–∫–æ —Å–ª—É—Ö.", en:"There‚Äôs a rumor that {X} was near the presents‚Ä¶ but it‚Äôs not evidence."},
    {ru:"–ö—Ç–æ-—Ç–æ —à–µ–ø—á–µ—Ç, —á—Ç–æ {X} —Å–ª–∏—à–∫–æ–º —Å–ø–æ–∫–æ–π–Ω–æ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –ø—Ä–æ–ø–∞–∂—É‚Ä¶ –Ω–æ —ç—Ç–æ –Ω–µ —Ñ–∞–∫—Ç.", en:"Someone whispers that {X} reacts too calmly‚Ä¶ but it‚Äôs not a fact."},
    {ru:"–ì–æ–≤–æ—Ä—è—Ç, —á—Ç–æ {X} –∑–Ω–∞–µ—Ç –±–æ–ª—å—à–µ, —á–µ–º –≥–æ–≤–æ—Ä–∏—Ç‚Ä¶ –Ω–æ –º—ã –Ω–µ —É–≤–µ—Ä–µ–Ω—ã.", en:"They say {X} knows more than they say‚Ä¶ but we‚Äôre not sure."},
    {ru:"–°–ª—É—Ö: {X} —Å–µ–≥–æ–¥–Ω—è –∏–∑–±–µ–≥–∞–µ—Ç –ø—Ä—è–º—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤‚Ä¶ –Ω–æ —ç—Ç–æ –Ω–µ —É–ª–∏–∫–∞.", en:"Rumor: {X} avoids direct answers today‚Ä¶ but it‚Äôs not evidence."},
    {ru:"–•–æ–¥—è—Ç —Å–ª—É—Ö–∏ –ø—Ä–æ {X}: –∫—Ç–æ-—Ç–æ –≤–∏–¥–µ–ª, –∫–∞–∫ –æ–Ω —Å–º–æ—Ç—Ä–µ–ª –Ω–∞ —Ç—Ä–µ–∫ üéÅ —Å–ª–∏—à–∫–æ–º –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ‚Ä¶ –Ω–æ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å–ª–æ–≤–∞.", en:"Rumor about {X}: someone saw them watching the üéÅ track too closely‚Ä¶ just words."},
  ];

  // ---------- Timer (steady seconds, no skipping) ----------
  let timer = {
    total: 420,
    left: 420,
    running: false,
    interval: null,
    mode: "",
    endAt: null
  };

  function timerSet(mmssStr, modeLabel=""){
    const v = parseMMSS(mmssStr);
    if(v===null){ toast("mm:ss"); return; }
    timer.total = v;
    timer.left  = v;
    timer.mode  = modeLabel;
    timer.endAt = null;
    timerStop();
    updateTimerUI();
  }

  function computeLeft(){
    if(!timer.endAt) return timer.left;
    const msLeft = timer.endAt - Date.now();
    return Math.max(0, Math.ceil(msLeft / 1000));
  }

  function tick(){
    const newLeft = computeLeft();
    if(newLeft !== timer.left){
      timer.left = newLeft;
      updateTimerUI();
    }
    if(timer.left <= 0){
      timer.left = 0;
      timerStop();
      updateTimerUI();
      toast(t('toastTime'));
    }
  }

  function timerStart(){
    if(timer.running) return;
    if(!timer.endAt){
      timer.endAt = Date.now() + timer.left * 1000;
    }else{
      timer.left = computeLeft();
      timer.endAt = Date.now() + timer.left * 1000;
    }
    timer.running = true;
    timer.interval = setInterval(tick, 250);
    tick();
    updateTimerUI();
  }

  function timerStop(){
    timer.running = false;
    if(timer.interval){
      clearInterval(timer.interval);
      timer.interval = null;
    }
    if(timer.endAt){
      timer.left = computeLeft();
      timer.endAt = null;
    }
    updateTimerUI();
  }

  function timerReset(){
    timerStop();
    timer.left = timer.total;
    timer.endAt = null;
    updateTimerUI();
  }

  function updateTimerUI(){
    $('timerLeft').textContent = mmss(timer.left);
    $('timerModeTag').textContent = timer.mode ? timer.mode : "‚Äî";
    $('timerInput').value = mmss(timer.total);

    $('tStart').textContent = (lang==="ru" ? "–°—Ç–∞—Ä—Ç" : "Start");
    $('tPause').textContent = (lang==="ru" ? "–ü–∞—É–∑–∞" : "Pause");
    $('tReset').textContent = (lang==="ru" ? "–°–±—Ä–æ—Å" : "Reset");
  }

  // ---------- Roles ----------
  const ROLE_SETS = {
    6:["Grinch","Max","Cindy","Mayor","Guard","Citizen"],
    7:["Grinch","Max","Cindy","Mayor","Guard","Citizen","Citizen"]
  };
  function roleLabel(role){
    const map = {
      Grinch: {ru:"Grinch", en:"Grinch"},
      Max: {ru:"Max", en:"Max"},
      Cindy: {ru:"Cindy Lou", en:"Cindy Lou"},
      Mayor: {ru:"Mayor", en:"Mayor"},
      Guard: {ru:"Mayor‚Äôs Guard", en:"Mayor‚Äôs Guard"},
      Citizen: {ru:"Citizen", en:"Citizen"},
    };
    return (map[role] ? map[role][lang] : role);
  }
  function findRoleIndex(role){
    const idx = state.players.findIndex(p => p.role === role);
    return idx >= 0 ? idx : null;
  }

  // ---------- UI wiring ----------
  function applyI18n(){
    $('uiTitle').textContent = t('uiTitle');
    $('uiPill1').textContent = t('pill1');
    $('uiPill2').textContent = t('pill2');

    $('leftHead').textContent = t('leftHead');
    $('rightHead').textContent = t('rightHead');

    $('lblPresents').textContent = (lang==="ru" ? "–ü–æ–¥–∞—Ä–∫–∏ üéÅ" : "Presents üéÅ");
$('lblHearts').textContent   = (lang==="ru" ? "–°–µ—Ä–¥—Ü–∞ ‚ù§Ô∏è" : "Hearts ‚ù§Ô∏è");
$('lblDay').textContent      = (lang==="ru" ? "–î–µ–Ω—å" : "Day");

    $('subPresents').textContent = lang==="ru" ? "0‚Ä¶—Å—Ç–∞—Ä—Ç (–Ω–µ –≤—ã—à–µ)" : "0‚Ä¶start (not above)";
    $('subHearts').textContent = lang==="ru" ? "0‚Ä¶8 (8 = –ø–æ–±–µ–¥–∞)" : "0‚Ä¶8 (8 = win)";
    $('subDay').textContent = lang==="ru" ? "–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–Ω—Ü–µ Day 6" : "Win check at end of Day 6";

    $('tagSaved').textContent = t('saved');
    $('tagState').textContent = state.started ? t('stateRunning') : t('stateNotStarted');

    $('capTitle').textContent = t('capTitle');
    $('capSub').textContent = t('capSub');
    $('timerTitle').textContent = t('timerTitle');
    $('timerLeftLbl').textContent = t('timerLeftLbl');
    $('timerLabel').textContent = t('timerLabel');
    $('presetsLabel').textContent = t('presets');

    $('btnExport').textContent = t('export');
    $('btnReset').textContent = t('newGame');
    $('btnLang').textContent = t('lang');

    $('winHint').innerHTML = t('winHint');
    $('btnWinCheck').textContent = t('checkWin');
    $('btnUndo').textContent = t('undo');

    // Steps titles
    $('s1Title').textContent = t('s1Title');
    $('s1Sub').textContent = t('s1Sub');
    $('playersCountLbl').textContent = t('players');
    $('playersNamesLbl').textContent = t('names');
    $('rolesModeLbl').textContent = t('rolesMode');
    $('rolesMode').options[0].text = t('rolesKnown');
    $('rolesMode').options[1].text = t('rolesUnknown');
    $('rolesHint').textContent = t('rolesHint');
    $('btnInit').textContent = t('create');
    $('btnAutoRoles').textContent = t('autoRoles');
    $('btnClearRoles').textContent = t('clearRoles');
    $('rolesAssignLbl').textContent = t('rolesAssign');
    $('rolesAssignTip').textContent = t('rolesAssignTip');
    $('s1Next').textContent = t('nextNight');

    $('s2Title').textContent = t('s2Title');
    $('s2Sub').textContent = t('s2Sub');
    $('grinchTargetLbl').textContent = t('grinchTarget');
    $('guardTargetLbl').textContent = t('guardTarget');
    $('maxTargetLbl').textContent = t('maxTarget');
    $('maxEffectLbl').textContent = t('maxEffect');
    $('maxEffectHelp').textContent = t('maxHelp');
    $('btnResolveNight').textContent = t('resolveNight');
    $('btnMaxSwitch').textContent = t('maxSwitch');
    $('nightExplain').innerHTML = `<b>${lang==="ru"?"–ù–æ—á—å:":"Night:"}</b> ${t('nightExplain')}`;
    $('guardWarn').textContent = t('guardRepeat');
    $('s2Prev').textContent = lang==="ru" ? "‚Üê –ù–∞–∑–∞–¥" : "‚Üê Back";
    $('s2Next').textContent = lang==="ru" ? "–î–∞–ª—å—à–µ ‚Üí –£—Ç—Ä–æ" : "Next ‚Üí Morning";

    $('s3Title').textContent = t('s3Title');
    $('s3Sub').textContent = t('s3Sub');
    $('morningTextLbl').textContent = t('morningText');
    $('rumorTitle').textContent = t('rumor');
    $('btnNewRumor').textContent = t('newRumor');
    $('barkTitle').textContent = t('bark');
    $('barkInfo').textContent = t('barkInfo');
    $('btnBarkSuccess').textContent = t('barkSuccess');
    $('btnBarkFail').textContent = t('barkFail');
    $('btnSetBarkTimer').textContent = t('setBark');
    $('s3Prev').textContent = lang==="ru" ? "‚Üê –ù–∞–∑–∞–¥" : "‚Üê Back";
    $('s3Next').textContent = t('nextEvent');

    $('s4Title').textContent = t('s4Title');
    $('s4Sub').textContent = t('s4Sub');
    $('btnDrawEvent').textContent = t('drawEvent');
    $('btnRerollEvent').textContent = t('reroll');
    $('eventResultLbl').textContent = t('eventResult');
    $('selEventResult').options[0].text = lang==="ru" ? "–ü–æ–∫–∞ –Ω–µ —Ä–µ—à–µ–Ω–æ" : "Not decided";
    $('selEventResult').options[1].text = lang==="ru" ? "–£—Å–ø–µ—Ö" : "Success";
    $('selEventResult').options[2].text = lang==="ru" ? "–ü—Ä–æ–≤–∞–ª" : "Fail";
    $('btnApplyEvent').textContent = t('applyEvent');
    $('eventHint').textContent = t('eventHint');
    $('s4Prev').textContent = lang==="ru" ? "‚Üê –ù–∞–∑–∞–¥" : "‚Üê Back";
    $('s4Next').textContent = t('nextDiscuss');

    $('s5Title').textContent = t('s5Title');
    $('s5Sub').textContent = t('s5Sub');
    $('mayorProtLbl').textContent = t('mayorProt');
    $('btnSaveMayor').textContent = t('saveProt');
    $('btnSetDiscussTimer').textContent = t('setDiscuss');
    $('cindyLbl').textContent = t('cindy');
    $('btnCindyKindness').textContent = t('kindness');
    $('cindyHint').textContent = t('cindyHint');
    $('mayorWarn').textContent = t('mayorRepeat');
    $('s5Prev').textContent = lang==="ru" ? "‚Üê –ù–∞–∑–∞–¥" : "‚Üê Back";
    $('s5Next').textContent = t('nextVote');

    $('s6Title').textContent = t('s6Title');
    $('s6Sub').textContent = t('s6Sub');
    $('tieLbl').textContent = t('tie');
    $('selTie').options[0].text = t('tieNo');
    $('selTie').options[1].text = t('tieYes');
    $('selTie').options[2].text = t('tieDouble');
    $('btnSetTieTimer').textContent = t('setTie');
    $('banishedLbl').textContent = t('banished');
    $('revealSideLbl').textContent = t('reveal');
    $('selRevealSide').options[0].text = "Whoville (Good)";
    $('selRevealSide').options[1].text = "Grinch Team (Bad)";
    $('grinchBanishedLbl').textContent = t('grinchBanished');
    $('btnApplyVote').textContent = t('applyVote');
    $('voteNote').textContent = t('voteNote');
    $('voteProtectedWarn').textContent = t('cannotBanishProtected');

    $('spiritTitle').textContent = t('spiritTitle');
    $('spiritMeta').textContent = t('spiritMeta');
    $('spiritWhoLbl').textContent = t('spiritWho');
    $('spiritEffectLbl').textContent = t('spiritEffect');
    $('selSpiritEffect').options[0].text = "+1 Heart";
    $('selSpiritEffect').options[1].text = "Cancel -1 Heart";
    $('btnUseSpirit').textContent = t('useBonus');

    $('s6Prev').textContent = lang==="ru" ? "‚Üê –ù–∞–∑–∞–¥" : "‚Üê Back";
    $('s6Next').textContent = t('nextEod');

    $('s7Title').textContent = t('s7Title');
    $('s7Sub').textContent = t('s7Sub');
    $('heartsChecklistTitle').textContent = t('heartsChecklist');
    $('lblCindyAlive').textContent = t('cindyAlive');
    $('lblNoTie').textContent = t('noTie');
    $('lblEventHeart').textContent = t('eventHeart');
    $('lblWrongBanish').textContent = t('wrongBanish');
    $('btnApplyEOD').textContent = t('applyEod');
    $('btnNextDay').textContent = t('nextDay');
    $('logHead').textContent = t('log');

    $('winModalTitle').textContent = t('modalTitle');
    $('btnCloseWin').textContent = t('close');
    $('btnHardStop').textContent = t('stop');
    $('btnNewGame2').textContent = t('newGame');

    updateTimerUI();
  }

  // ---------- Rendering ----------
  function setActiveStep(n){
    state.step = clamp(n,1,7);
    for(let i=1;i<=7;i++){
      const el = $('step'+i);
      if(!el) continue;
      el.classList.toggle('active', i===state.step);
    }
    $('tagStep').textContent = `Step ${state.step}/7`;
    saveState();
  }

  function updateKPIs(){
    $('kPresents').textContent = String(state.presents);
    $('kHearts').textContent = String(state.hearts);
    $('kDay').textContent = String(state.day);

    $('capTag').textContent = `Today +üéÅ: ${state.presentGainedToday ? "YES" : "NO"}`;
    $('tagState').textContent = state.started ? t('stateRunning') : t('stateNotStarted');

    $('tagMaxSide').textContent = `Max: ${state.maxSide}`;
    $('tagMaxSide').classList.toggle('bad', state.maxSide==="Bad");
    $('tagMaxSide').classList.toggle('good', state.maxSide==="Good");

    $('tagBark').textContent = state.barkActive ? (state.barkResolved ? "Bark: done" : "Bark: pending") : "Bark: off";
    $('tagBark').classList.toggle('warn', state.barkActive && !state.barkResolved);
  }

  function renderPlayersSelects(){
    const aliveNames = state.players.filter(byAlive).map(p=>p.name);

    function fillSelect(selId, list, includeNone=true){
      const sel = $(selId);
      if(!sel) return;
      const prev = sel.value;
      sel.innerHTML = "";
      if(includeNone){
        const opt = document.createElement('option');
        opt.value = "";
        opt.textContent = "‚Äî";
        sel.appendChild(opt);
      }
      list.forEach(n=>{
        const o = document.createElement('option');
        o.value = n;
        o.textContent = n;
        sel.appendChild(o);
      });
      if(prev && [...sel.options].some(o=>o.value===prev)) sel.value = prev;
    }

    fillSelect('selGrinchTarget', aliveNames, false);
    fillSelect('selGuardTarget', aliveNames, false);
    fillSelect('selMaxTarget', aliveNames, false);

    fillSelect('selMayorProt1', aliveNames, true);
    fillSelect('selMayorProt2', aliveNames, true);

    fillSelect('selBanished', aliveNames, true);

    // spirit who: dead players (spirits). if none yet -> show placeholder list (alive) but still allow none.
    const spirits = state.players.filter(p=>!p.alive).map(p=>p.name);
    fillSelect('selSpiritWho', spirits.length ? spirits : aliveNames, true);
  }

  function renderRolesTable(){
    const box = $('rolesBox');
    box.style.display = (state.rolesMode === "known") ? "block" : "none";
    $('grinchBanishedBox').style.display = (state.rolesMode === "unknown") ? "block" : "none";
    $('grinchBanishedTip').textContent = (lang==="ru")
      ? "–ù—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —É—Å–ª–æ–≤–∏—è ¬´Grinch –∏–∑–≥–Ω–∞–Ω –ø—Ä–∏ üéÅ‚â•6¬ª."
      : "Only needed for ‚ÄúGrinch banished while üéÅ‚â•6‚Äù win condition.";

    if(state.rolesMode !== "known") { $('rolesTable').innerHTML = ""; return; }

    const roles = ROLE_SETS[state.playersCount].slice();
    const html = [];
    html.push(`<div class="two">`);
    for(let i=0;i<state.players.length;i++){
      const p = state.players[i];
      const opts = [''].concat(roles).map(r=>{
        const label = r ? roleLabel(r) : "‚Äî";
        const sel = (p.role===r) ? "selected" : "";
        return `<option value="${r}" ${sel}>${label}</option>`;
      }).join('');
      html.push(`
        <div style="padding:10px;border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(0,0,0,.14)">
          <div style="font-weight:900">${p.name}</div>
          <div style="margin-top:8px">
            <select data-role-index="${i}">${opts}</select>
          </div>
          <div class="small" style="margin-top:8px">${p.alive ? "Alive" : "Banished"}</div>
        </div>
      `);
    }
    html.push(`</div>`);
    $('rolesTable').innerHTML = html.join('');

    // enforce unique roles (except Citizen)
    const selects = $('rolesTable').querySelectorAll('select[data-role-index]');
    selects.forEach(sel=>{
      sel.addEventListener('change', (e)=>{
        const idx = parseInt(e.target.getAttribute('data-role-index'),10);
        const val = e.target.value || "";
        setUndo();
        state.players[idx].role = val;

        // uniqueness: Grinch/Max/Cindy/Mayor/Guard must be unique
        const unique = ["Grinch","Max","Cindy","Mayor","Guard"];
        if(unique.includes(val)){
          for(let j=0;j<state.players.length;j++){
            if(j!==idx && state.players[j].role===val){
              state.players[j].role="";
            }
          }
        }
        saveState();
        render();
      });
    });
  }

  function renderMorningText(){
    if(!state.started){ $('morningText').value=""; return; }
    const stealLine = state._lastStealSuccess ? (lang==="ru" ? "–∫—Ä–∞–∂–∞ –±—ã–ª–∞" : "a steal happened") : (lang==="ru" ? "–∫—Ä–∞–∂–∏ –Ω–µ –±—ã–ª–æ" : "no steal");
    const base = (lang==="ru")
      ? `–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, Whoville.\n–°–µ–≥–æ–¥–Ω—è –Ω–æ—á—å—é: ${stealLine}.\nPresents = ${state.presents}, Hearts = ${state.hearts}.`
      : `Good morning, Whoville.\nLast night: ${stealLine}.\nPresents = ${state.presents}, Hearts = ${state.hearts}.`;

    let extra = "";
    if(state.rumorActive){
      extra += "\n\n" + (lang==="ru"
        ? `–ò –µ—â—ë‚Ä¶ ${state.rumorText}\n(–≠—Ç–æ –ù–ï –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ.)`
        : `And one more thing‚Ä¶ ${state.rumorText}\n(This is NOT evidence.)`);
    }
    if(state.barkActive){
      extra += "\n\n" + (lang==="ru"
        ? `Bark Alarm: –ø–µ—Ä–≤—ã–µ 30 —Å–µ–∫—É–Ω–¥ –¥–Ω—è ‚Äî —Ç–∏—à–∏–Ω–∞.`
        : `Bark Alarm: first 30 seconds ‚Äî silence.`);
    }
    $('morningText').value = base + extra;

    $('rumorLine').textContent = state.rumorActive ? state.rumorText : "‚Äî";
  }

  function renderEvent(){
    if(!state.currentEvent){
      $('eventName').textContent = "‚Äî";
      $('eventDesc').textContent = "‚Äî";
      $('eventTag').textContent = "‚Äî";
      $('eventAppliedNote').textContent = "‚Äî";
      $('eventCapWarn').classList.remove('show');
      return;
    }
    const e = state.currentEvent;
    $('eventName').textContent = e.name[lang];
    $('eventDesc').textContent = e.text[lang];
    $('eventTag').textContent = e.type.toUpperCase();
    $('eventAppliedNote').textContent = state.eventApplied
      ? (lang==="ru" ? "–°–æ–±—ã—Ç–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ." : "Event applied.")
      : (lang==="ru" ? "–°–æ–±—ã—Ç–∏–µ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ." : "Not applied yet.");
  }

  function autoFillChecklist(){
    // Cindy alive:
    // - known roles: auto only if Cindy role is set
    // - unknown roles: do NOT override (host sets manually)
    if(state.rolesMode === "known"){
      const cindyIdx = findRoleIndex("Cindy");
      if(cindyIdx !== null){
        $('chkCindyAlive').checked = !!state.players[cindyIdx].alive;
      }
    }

    // No tie heart only if tie === "no"
    $('chkNoTie').checked = (state.tie === "no");

    // Event heart succeeded
    const e = state.currentEvent;
    $('chkEventHeart').checked = !!(e && e.type==="heart" && state.eventApplied && state.eventResult==="success");

    // Wrong banish (can be canceled by Spirit)
    $('chkWrongBanish').checked = state.wrongBanishToday && !state.spiritCanceledWrong;
  }

  function render(){
    applyI18n();
    updateKPIs();

    // lock UI if locked
    const disabled = state.locked;
    document.querySelectorAll("button, input, select, textarea").forEach(el=>{
      if(el.closest('#winModal')) return;
      if(el.id==="btnLang" || el.id==="btnExport" || el.id==="btnReset") return;
      el.disabled = disabled;
    });

    // setup selections
    $('playersCount').value = String(state.playersCount);
    $('playersNames').value = state.players.map(p=>p.name).join(", ");
    $('rolesMode').value = state.rolesMode;

    // show steps
    for(let i=1;i<=7;i++){
      $('step'+i).classList.toggle('active', i===state.step);
    }
    $('tagStep').textContent = `Step ${state.step}/7`;

    // step tags
    $('s1Tag').textContent = state.started ? "OK" : "‚Äî";
    $('s2Tag').textContent = state.started ? "Ready" : "‚Äî";
    $('s3Tag').textContent = state.started ? "Ready" : "‚Äî";
    $('s5Tag').textContent = state.mayorSaved ? "Saved" : "‚Äî";
    $('s6Tag').textContent = state.banished ? "Applied" : "‚Äî";
    $('s7Tag').textContent = "‚Äî";

    // fill selects from players
    renderPlayersSelects();

    // night fields
    $('selMaxEffect').value = state.night.maxEffect || "Rumor";
    if(state.night.grinch) $('selGrinchTarget').value = state.night.grinch;
    if(state.night.guard) $('selGuardTarget').value = state.night.guard;
    if(state.night.maxTarget) $('selMaxTarget').value = state.night.maxTarget;

    // guard rule warning
    const guardPick = $('selGuardTarget').value;
    $('guardWarn').classList.toggle('show', !!(state.lastGuard && guardPick && guardPick===state.lastGuard));

    // morning
    renderMorningText();
    $('barkWarn').classList.toggle('show', false);

    // event
    $('selEventResult').value = state.eventResult || "none";
    renderEvent();
    $('eventCapWarn').classList.toggle('show', false);

    // mayor
    $('selMayorProt1').value = state.mayorProt[0] || "";
    $('selMayorProt2').value = state.mayorProt[1] || "";
    $('mayorWarn').classList.remove('show');
    $('mayorSavedNote').textContent = state.mayorSaved
      ? (lang==="ru"
        ? `–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${state.mayorProt.filter(Boolean).join(" & ") || "‚Äî"}`
        : `Saved: ${state.mayorProt.filter(Boolean).join(" & ") || "‚Äî"}`)
      : "‚Äî";

    // Cindy
    $('cindyNote').textContent = state.cindyKindnessUsed
      ? (lang==="ru" ? "Kindness Round —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω." : "Kindness Round already used.")
      : (lang==="ru" ? "–ú–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å 1 —Ä–∞–∑ –∑–∞ –∏–≥—Ä—É." : "Can be used once per game.");

    // vote
    $('selTie').value = state.tie || "no";
    $('selRevealSide').value = state.revealSide || "Good";
    $('selBanished').value = state.banished || "";
    $('voteProtectedWarn').classList.remove('show');

    // Spirit note (per-spirit, once per game)
    const spirits = state.players.filter(p=>!p.alive);
    if(!spirits.length){
      $('spiritNote').textContent = (lang==="ru")
        ? "–ü–æ–∫–∞ –Ω–µ—Ç –∏–∑–≥–Ω–∞–Ω–Ω—ã—Ö ‚Äî –±–æ–Ω—É—Å –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω."
        : "No banished players yet ‚Äî bonus unavailable.";
    }else{
      $('spiritNote').textContent = (lang==="ru")
        ? "–ö–∞–∂–¥—ã–π –¥—É—Ö –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–Ω—É—Å 1 —Ä–∞–∑ –∑–∞ –∏–≥—Ä—É."
        : "Each spirit can use the bonus once per game.";
    }

    $('logBox').textContent = state.log.length ? state.log.join("\n") : "‚Äî";

    // roles
    $('rolesMode').value = state.rolesMode;
    $('rolesHint').textContent = t('rolesHint');
    renderRolesTable();

    // End of day auto-fill
    autoFillChecklist();

    // rules hint in step 7
    $('rulesHint').innerHTML = (lang==="ru")
      ? "<b>–ü–∞–º—è—Ç–∫–∞:</b> Bark (+1 ‚ù§Ô∏è) ‚Äî —É—Ç—Ä–æ–º, –æ—Ç–¥–µ–ª—å–Ω–æ. –í –∫–æ–Ω—Ü–µ –¥–Ω—è: Cindy alive (+1 ‚ù§Ô∏è), no tie (+1 ‚ù§Ô∏è), event-heart (+1 ‚ù§Ô∏è), wrong banish (-1 ‚ù§Ô∏è). –ó–∞—Ç–µ–º –ø–æ–±–µ–¥–∞. –ü–æ—Ç–æ–º —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å.<br><span class='small'>Gift Audit: –µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –æ—à–∏–±–æ—á–Ω–æ –∏–∑–≥–Ω–∞–ª–∏ Good ‚Äî –≤ –∫–æ–Ω—Ü–µ –¥–Ω—è –µ—â—ë -1 üéÅ (–Ω–µ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è –¥—É—Ö–æ–º).</span>"
      : "<b>Reminder:</b> Bark (+1 ‚ù§Ô∏è) is in the morning, separate. End of day: Cindy alive (+1 ‚ù§Ô∏è), no tie (+1 ‚ù§Ô∏è), event-heart (+1 ‚ù§Ô∏è), wrong banish (-1 ‚ù§Ô∏è). Then win check. Then next day.<br><span class='small'>Gift Audit: if wrong banish today (Good) ‚Äî extra -1 üéÅ at EOD (not canceled by Spirit).</span>";

    saveState();
  }

  // ---------- Core actions ----------
  function initGame(){
    if(state.locked) return;
    setUndo();
    const pc = parseInt($('playersCount').value,10);
    const namesRaw = $('playersNames').value.trim();
    const names = namesRaw
      ? namesRaw.split(",").map(s=>s.trim()).filter(Boolean)
      : [];
    const needed = pc;
    const list = [];
    for(let i=0;i<needed;i++){
      const name = names[i] || (lang==="ru" ? `–ò–≥—Ä–æ–∫ ${i+1}` : `Player ${i+1}`);
      list.push({name, role:"", alive:true, spiritUsed:false});
    }
    state.playersCount = pc;
    state.rolesMode = $('rolesMode').value || "known";

    state.players = list;
    state.startPresents = (pc===6) ? 10 : 12;
    state.presents = state.startPresents;
    state.hearts = 0;
    state.day = 1;
    state.presentGainedToday = false;

    state.lastGuard = null;
    state.night = { grinch:null, guard:null, maxTarget:null, maxEffect:"Rumor" };
    state.maxSide = "Bad";
    state.maxSwitched = false;
    state.barkActive = false;
    state.barkResolved = false;
    state.rumorActive = false;
    state.rumorText = "";
    state._lastStealSuccess = false;

    state.currentEvent = null;
    state.lastEventType = null;
    state.eventApplied = false;
    state.eventResult = "none";

    state.mayorProt = [null,null];
    state.mayorLastProt = [null,null];
    state.mayorSaved = false;

    state.tie = "no";
    state.banished = null;
    state.revealSide = "Good";
    state.wrongBanishToday = false;
    state.grinchBanishedToday = false;
    state.spiritCanceledWrong = false;

    state.cindyKindnessUsed = false;

    state.log = [];
    addLog(lang==="ru" ? `–°—Ç–∞—Ä—Ç –ø–∞—Ä—Ç–∏–∏: ${pc} –∏–≥—Ä–æ–∫–æ–≤. Presents=${state.startPresents}, Hearts=0.` : `Game start: ${pc} players. Presents=${state.startPresents}, Hearts=0.`);
    state.started = true;
    state.step = 1;
    timerSet("07:00", "Discussion");

    render();
  }

  function autoAssignRoles(){
    if(!state.started){ $('setupWarn').textContent = t('needGame'); $('setupWarn').classList.add('show'); return; }
    if(state.rolesMode !== "known"){
      $('setupWarn').textContent = (lang==="ru" ? "–†–µ–∂–∏–º —Ä–æ–ª–µ–π = Unknown. –ü–µ—Ä–µ–∫–ª—é—á–∏ –Ω–∞ Known, —á—Ç–æ–±—ã –∞–≤—Ç–æ-—Ä–∞–∑–¥–∞—Ç—å." : "Roles mode is Unknown. Switch to Known to auto-assign.");
      $('setupWarn').classList.add('show');
      return;
    }
    $('setupWarn').classList.remove('show');
    setUndo();
    const roles = ROLE_SETS[state.playersCount].slice();
    for(let i=roles.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [roles[i], roles[j]] = [roles[j], roles[i]];
    }
    state.players.forEach((p,i)=> p.role = roles[i] || "");
    addLog(lang==="ru" ? "–ê–≤—Ç–æ-—Ä–∞–∑–¥–∞—á–∞ —Ä–æ–ª–µ–π –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ (—Ç–æ–ª—å–∫–æ –≤–µ–¥—É—â–µ–º—É)." : "Auto roles assigned (host only).");
    render();
  }

  function clearRoles(){
    if(!state.started) return;
    setUndo();
    state.players.forEach(p=>p.role="");
    addLog(lang==="ru" ? "–†–æ–ª–∏ –æ—á–∏—â–µ–Ω—ã." : "Roles cleared.");
    render();
  }

  function resolveNight(){
    if(!state.started){ toast(t('needGame')); return; }
    const g = $('selGrinchTarget').value;
    const guard = $('selGuardTarget').value;
    const mt = $('selMaxTarget').value;
    const me = $('selMaxEffect').value;

    if(!g || !guard || !mt || !me){ toast(t('fillNight')); return; }

    if(state.lastGuard && guard === state.lastGuard){
      $('guardWarn').classList.add('show');
      toast(t('guardRepeat'));
      return;
    }
    $('guardWarn').classList.remove('show');

    setUndo();
    state.night.grinch = g;
    state.night.guard = guard;
    state.night.maxTarget = mt;
    state.night.maxEffect = me;

    const blocked = (guard === g) && !(me === "ScentTrail" && mt === g);
    const stealSuccess = !blocked;

    state._lastStealSuccess = stealSuccess;
    if(stealSuccess){
      state.presents = clamp(state.presents - 1, 0, state.startPresents);
      addLog((lang==="ru")
        ? `–ù–æ—á—å: –∫—Ä–∞–∂–∞ –£–°–ü–ï–®–ù–ê. üéÅ -1 (Grinch‚Üí${g}, Guard‚Üí${guard}, Max:${me}‚Üí${mt}).`
        : `Night: steal SUCCESS. üéÅ -1 (Grinch‚Üí${g}, Guard‚Üí${guard}, Max:${me}‚Üí${mt}).`);
    }else{
      addLog((lang==="ru")
        ? `–ù–æ—á—å: –∫—Ä–∞–∂–∏ –ù–ï–¢ (Guard —Å–ø–∞—Å). (Grinch‚Üí${g}, Guard‚Üí${guard}, Max:${me}‚Üí${mt}).`
        : `Night: NO steal (Guard blocked). (Grinch‚Üí${g}, Guard‚Üí${guard}, Max:${me}‚Üí${mt}).`);
    }

    state.rumorActive = (me === "Rumor");
    state.barkActive  = (me === "BarkAlarm");
    state.barkResolved = false;

    if(state.rumorActive){
      state.rumorText = genRumor(mt);
      addLog(lang==="ru" ? `Rumor –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –ø—Ä–æ ${mt}.` : `Rumor activated about ${mt}.`);
    }else{
      state.rumorText = "";
    }
    if(state.barkActive){
      addLog(lang==="ru" ? `Bark Alarm –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω (30 —Å–µ–∫ —Ç–∏—à–∏–Ω—ã —É—Ç—Ä–æ–º).` : `Bark Alarm activated (30s silence in morning).`);
    }

    state.lastGuard = guard;

    setActiveStep(3);
    render();
    checkWinAuto(); // if presents hit 0
  }

  function genRumor(targetName){
    const r = RUMORS[Math.floor(Math.random()*RUMORS.length)];
    return r[lang].replace("{X}", targetName);
  }

  function newRumor(){
    if(!state.rumorActive){
      toast(lang==="ru" ? "Rumor –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω" : "Rumor not active");
      return;
    }
    setUndo();
    state.rumorText = genRumor(state.night.maxTarget || "‚Äî");
    addLog(lang==="ru" ? "Rumor –æ–±–Ω–æ–≤–ª—ë–Ω." : "Rumor refreshed.");
    render();
  }

  function barkSuccess(){
    if(!state.barkActive){ toast(lang==="ru"?"Bark –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω":"Bark not active"); return; }
    if(state.barkResolved){ $('barkWarn').textContent = lang==="ru"?"Bark —É–∂–µ —Ä–µ—à—ë–Ω":"Bark already resolved"; $('barkWarn').classList.add('show'); return; }
    setUndo();
    state.barkResolved = true;
    state.hearts = clamp(state.hearts + 1, 0, 8);
    addLog(lang==="ru" ? "Bark: —É—Å–ø–µ—Ö. ‚ù§Ô∏è +1 (—É—Ç—Ä–æ)." : "Bark: success. ‚ù§Ô∏è +1 (morning).");
    render();
    checkWinAuto();
  }
  function barkFail(){
    if(!state.barkActive){ toast(lang==="ru"?"Bark –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω":"Bark not active"); return; }
    if(state.barkResolved){ $('barkWarn').textContent = lang==="ru"?"Bark —É–∂–µ —Ä–µ—à—ë–Ω":"Bark already resolved"; $('barkWarn').classList.add('show'); return; }
    setUndo();
    state.barkResolved = true;
    addLog(lang==="ru" ? "Bark: –ø—Ä–æ–≤–∞–ª. ‚ù§Ô∏è +0." : "Bark: fail. ‚ù§Ô∏è +0.");
    render();
  }

  function maxSwitch(){
    if(!state.started){ toast(t('needGame')); return; }
    if(state.day < 4){ toast(t('maxTooEarly')); return; } // after Day 3
    if(state.maxSwitched){ toast(t('maxAlready')); return; }
    setUndo();
    state.maxSwitched = true;
    state.maxSide = "Good";
    addLog(lang==="ru" ? "Max –æ–±—ä—è–≤–∏–ª –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω—É Whoville." : "Max switched to Whoville.");
    render();
  }

  function pickEventAvoidingPresentStreak(forceReroll=false){
    const avoidPresent = (state.lastEventType === "present");
    const maxAttempts = 60;

    for(let i=0;i<maxAttempts;i++){
      const e = EVENTS[Math.floor(Math.random()*EVENTS.length)];
      if(avoidPresent && e.type === "present") continue;
      return {event:e, avoided: avoidPresent && e.type !== "present"};
    }

    // Fallback: if too unlucky, just return any non-present if exists
    if(avoidPresent){
      const nonPresents = EVENTS.filter(x=>x.type !== "present");
      if(nonPresents.length){
        return {event: nonPresents[Math.floor(Math.random()*nonPresents.length)], avoided:true};
      }
    }
    return {event: EVENTS[Math.floor(Math.random()*EVENTS.length)], avoided:false};
  }

  function drawEvent(reroll=false){
    if(!state.started){ toast(t('needGame')); return; }
    setUndo();

    const {event:e, avoided} = pickEventAvoidingPresentStreak(!!reroll);

    state.currentEvent = e;
    state.eventApplied = false;
    state.eventResult = "none";

    addLog((lang==="ru")
      ? `Day Event –≤—ã—Ç—è–Ω—É—Ç: ${e.name[lang]}${avoided ? " (üéÅ-—Å—Ç—Ä–∏–∫ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â—ë–Ω)" : ""}`
      : `Day Event drawn: ${e.name[lang]}${avoided ? " (prevented üéÅ streak)" : ""}`);

    $('eventCapWarn').classList.remove('show');
    render();
  }

  function rerollEvent(){
    drawEvent(true);
  }

  function applyEvent(){
    if(!state.currentEvent){ toast(lang==="ru" ? "–°–Ω–∞—á–∞–ª–∞ –≤—ã—Ç—è–Ω—É—Ç—å —Å–æ–±—ã—Ç–∏–µ" : "Draw event first"); return; }
    if(state.eventApplied){ toast(lang==="ru" ? "–£–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ" : "Already applied"); return; }
    const r = $('selEventResult').value;
    if(r === "none"){ toast(lang==="ru" ? "–í—ã–±–µ—Ä–∏ —É—Å–ø–µ—Ö/–ø—Ä–æ–≤–∞–ª" : "Choose success/fail"); return; }

    setUndo();
    state.eventResult = r;
    const e = state.currentEvent;

    let note = "";
    if(r === "success"){
      if(e.onSuccess.heart){
        state.hearts = clamp(state.hearts + e.onSuccess.heart, 0, 8);
        note += `‚ù§Ô∏è +${e.onSuccess.heart}. `;
      }
      if(e.onSuccess.present){
        if(!state.presentGainedToday && state.presents < state.startPresents){
          state.presents = clamp(state.presents + 1, 0, state.startPresents);
          state.presentGainedToday = true;
          note += (lang==="ru") ? `üéÅ +1 (–ª–∏–º–∏—Ç –ø–æ—Ç—Ä–∞—á–µ–Ω). ` : `üéÅ +1 (cap used). `;
        }else{
          $('eventCapWarn').classList.add('show');
          note += (lang==="ru") ? `üéÅ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω (–ª–∏–º–∏—Ç/–ø–æ—Ç–æ–ª–æ–∫). ` : `üéÅ not added (cap/ceiling). `;
        }
      }
      if(e.id === 1){
        note += (lang==="ru") ? `–ü–æ—Å—Ç–∞–≤—å —Ç–∞–π–º–µ—Ä 05:00 –Ω–∞ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ.` : `Set discussion timer to 05:00.`;
      }
    }else{
      if(e.onFail.heart){
        state.hearts = clamp(state.hearts + e.onFail.heart, 0, 8);
        note += `‚ù§Ô∏è ${e.onFail.heart}. `;
      }
      if(e.onFail.present){
        state.presents = clamp(state.presents + e.onFail.present, 0, state.startPresents);
        note += `üéÅ ${e.onFail.present}. `;
      }
    }

    state.eventApplied = true;
    state.lastEventType = e.type;

    addLog((lang==="ru")
      ? `Day Event: ${e.name[lang]} ‚Üí ${r==="success"?"—É—Å–ø–µ—Ö":"–ø—Ä–æ–≤–∞–ª"}. ${note}`.trim()
      : `Day Event: ${e.name[lang]} ‚Üí ${r}. ${note}`.trim());

    $('eventAppliedNote').textContent = note || "‚Äî";
    render();
    checkWinAuto();
  }

  function saveMayor(){
    if(!state.started){ toast(t('needGame')); return; }
    setUndo();
    const a = $('selMayorProt1').value || null;
    const b = $('selMayorProt2').value || null;

    const aliveCount = state.players.filter(byAlive).length;
    const needTwo = (aliveCount >= 2);

    if(needTwo && (!a || !b)){
      $('mayorWarn').textContent = t('mayorNeedTwo');
      $('mayorWarn').classList.add('show');
      return;
    }

    if(a && b && a === b){
      $('mayorWarn').textContent = (lang==="ru") ? "–ù–µ–ª—å–∑—è –∑–∞—â–∏—â–∞—Ç—å –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –¥–≤–∞–∂–¥—ã." : "Cannot protect same player twice.";
      $('mayorWarn').classList.add('show');
      return;
    }

    const yesterday = new Set((state.mayorLastProt||[]).filter(Boolean));
    const today = new Set([a,b].filter(Boolean));
    const repeated = [...today].some(x => yesterday.has(x));
    if(repeated){
      $('mayorWarn').textContent = t('mayorRepeat');
      $('mayorWarn').classList.add('show');
      return;
    }

    $('mayorWarn').classList.remove('show');
    state.mayorProt = [a,b];
    state.mayorSaved = true;

    addLog((lang==="ru")
      ? `Mayor protection: ${[a,b].filter(Boolean).join(" & ") || "‚Äî"}`
      : `Mayor protection: ${[a,b].filter(Boolean).join(" & ") || "‚Äî"}`);

    render();
  }

  function cindyKindness(){
    if(!state.started){ toast(t('needGame')); return; }
    if(state.cindyKindnessUsed){ toast(t('kindnessUsed')); return; }
    setUndo();

    if(!state.presentGainedToday && state.presents < state.startPresents){
      state.presents = clamp(state.presents + 1, 0, state.startPresents);
      state.presentGainedToday = true;
      addLog(lang==="ru" ? "Cindy Kindness: üéÅ +1 (–ª–∏–º–∏—Ç –ø–æ—Ç—Ä–∞—á–µ–Ω)." : "Cindy Kindness: üéÅ +1 (cap used).");
      $('cindyNote').textContent = lang==="ru" ? "–î–∞–ª üéÅ +1." : "Gave üéÅ +1.";
    }else{
      state.hearts = clamp(state.hearts + 1, 0, 8);
      addLog(lang==="ru" ? "Cindy Kindness: –ª–∏–º–∏—Ç üéÅ –∑–∞–Ω—è—Ç ‚Üí ‚ù§Ô∏è +1 –≤–º–µ—Å—Ç–æ üéÅ." : "Cindy Kindness: üéÅ cap used ‚Üí ‚ù§Ô∏è +1 instead.");
      $('cindyNote').textContent = lang==="ru" ? "–î–∞–ª ‚ù§Ô∏è +1 –≤–º–µ—Å—Ç–æ üéÅ." : "Gave ‚ù§Ô∏è +1 instead of üéÅ.";
    }

    state.cindyKindnessUsed = true;
    render();
    checkWinAuto();
  }

  function applyVote(){
    if(!state.started){ toast(t('needGame')); return; }

    const tie = $('selTie').value;
    const banished = $('selBanished').value || null;
    const reveal = $('selRevealSide').value;

    if(tie === "double"){
      setUndo();
      state.tie = "double";
      state.banished = null;
      state.revealSide = reveal;
      state.wrongBanishToday = false;
      state.grinchBanishedToday = false;
      state.spiritCanceledWrong = false;
      addLog(lang==="ru" ? "–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ: –Ω–∏—á—å—è –¥–≤–∞–∂–¥—ã ‚Üí –Ω–∏–∫–æ–≥–æ –Ω–µ –∏–∑–≥–æ–Ω—è–µ–º." : "Vote: tie twice ‚Üí no banishment.");
      render();
      return;
    }

    if(!banished){ toast(lang==="ru" ? "–í—ã–±–µ—Ä–∏ –∏–∑–≥–Ω–∞–Ω–Ω–æ–≥–æ" : "Pick banished"); return; }

    const prot = new Set(state.mayorProt.filter(Boolean));
    if(prot.has(banished)){
      $('voteProtectedWarn').classList.add('show');
      toast(t('cannotBanishProtected'));
      return;
    }
    $('voteProtectedWarn').classList.remove('show');

    setUndo();
    state.tie = tie;
    state.banished = banished;
    state.revealSide = reveal;

    const idx = state.players.findIndex(p=>p.name===banished);
    if(idx>=0){
      state.players[idx].alive = false;
    }

    state.wrongBanishToday = (reveal === "Good");
    state.spiritCanceledWrong = false;

    if(state.rolesMode === "known"){
      const grinchIdx = findRoleIndex("Grinch");
      state.grinchBanishedToday = (grinchIdx!==null && !state.players[grinchIdx].alive);
    }else{
      state.grinchBanishedToday = !!$('chkGrinchBanished').checked;
    }

    addLog((lang==="ru")
      ? `–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ: –∏–∑–≥–Ω–∞–Ω ${banished}. –û—Ç–∫—Ä—ã—Ç–∞—è —Å—Ç–æ—Ä–æ–Ω–∞: ${reveal}. ${tie==="yes" ? "(–±—ã–ª–∞ –Ω–∏—á—å—è ‚Üí –ø–µ—Ä–µ–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ)" : ""}`
      : `Vote: banished ${banished}. Revealed: ${reveal}. ${tie==="yes" ? "(tie ‚Üí revote happened)" : ""}`);

    render();
    checkWinAuto();
  }

  function useSpiritBonus(){
    if(!state.started){ toast(t('needGame')); return; }

    const who = $('selSpiritWho').value || null;
    const eff = $('selSpiritEffect').value;

    if(!who){
      toast(lang==="ru" ? "–í—ã–±–µ—Ä–∏ –¥—É—Ö–∞" : "Pick a spirit");
      return;
    }

    const p = state.players.find(x=>x.name===who);
    if(!p){ toast(lang==="ru" ? "–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω" : "Player not found"); return; }
    if(p.alive){
      toast(lang==="ru" ? "–≠—Ç–æ—Ç –∏–≥—Ä–æ–∫ –µ—â—ë –∂–∏–≤" : "This player is still alive");
      return;
    }
    if(p.spiritUsed){
      toast(t('spiritUsed'));
      return;
    }

    if(eff === "cancelWrong" && !state.wrongBanishToday){
      toast(t('spiritNoWrong'));
      return;
    }

    setUndo();
    p.spiritUsed = true;

    if(eff === "addHeart"){
      state.hearts = clamp(state.hearts + 1, 0, 8);
      addLog(lang==="ru" ? `Holiday Spirit (${who}): ‚ù§Ô∏è +1.` : `Holiday Spirit (${who}): ‚ù§Ô∏è +1.`);
      $('spiritNote').textContent = lang==="ru" ? "–î–∞–ª ‚ù§Ô∏è +1." : "Gave ‚ù§Ô∏è +1.";
    }else{
      state.spiritCanceledWrong = true;
      addLog(lang==="ru" ? `Holiday Spirit (${who}): –æ—Ç–º–µ–Ω–∏–ª —à—Ç—Ä–∞—Ñ -1 ‚ù§Ô∏è –∑–∞ –æ—à–∏–±–∫—É.` : `Holiday Spirit (${who}): canceled -1 ‚ù§Ô∏è penalty for wrong banishment.`);
      $('spiritNote').textContent = lang==="ru" ? "–û—Ç–º–µ–Ω–∏–ª -1 ‚ù§Ô∏è." : "Canceled -1 ‚ù§Ô∏è.";
    }

    render();
    checkWinAuto();
  }

  function applyEOD(){
    if(!state.started){ toast(t('needGame')); return; }
    setUndo();

    const cindy = $('chkCindyAlive').checked ? 1 : 0;
    const noTie = $('chkNoTie').checked ? 1 : 0;
    const eventH = $('chkEventHeart').checked ? 1 : 0;
    const wrong = $('chkWrongBanish').checked ? -1 : 0;

    const delta = cindy + noTie + eventH + wrong;
    state.hearts = clamp(state.hearts + delta, 0, 8);

    // Gift Audit mechanic:
    // If current event is 20 and wrong banish happened -> extra -1 üéÅ at end of day.
    // IMPORTANT: Spirit cancel affects ONLY ‚ù§Ô∏è penalty, NOT this üéÅ penalty.
    let giftAuditApplied = false;
    if(state.currentEvent && state.currentEvent.id === 20 && state.wrongBanishToday){
      const before = state.presents;
      state.presents = clamp(state.presents - 1, 0, state.startPresents);
      giftAuditApplied = (state.presents !== before);
      addLog(lang==="ru"
        ? `Gift Audit: –æ—à–∏–±–∫–∞ (Good) ‚Üí –¥–æ–ø. üéÅ -1 –≤ –∫–æ–Ω—Ü–µ –¥–Ω—è.`
        : `Gift Audit: wrong banish (Good) ‚Üí extra üéÅ -1 at EOD.`);
    }

    addLog((lang==="ru")
      ? `–ö–æ–Ω–µ—Ü –¥–Ω—è: Hearts ${delta>=0?"+":""}${delta}. –ò—Ç–æ–≥: üéÅ=${state.presents}, ‚ù§Ô∏è=${state.hearts}.`
      : `End of day: Hearts ${delta>=0?"+":""}${delta}. Totals: üéÅ=${state.presents}, ‚ù§Ô∏è=${state.hearts}.`);

    $('eodPreview').textContent = (lang==="ru")
      ? `Hearts change: ${delta>=0?"+":""}${delta} ‚Üí Hearts=${state.hearts}${giftAuditApplied ? " | Gift Audit: üéÅ -1" : ""}`
      : `Hearts change: ${delta>=0?"+":""}${delta} ‚Üí Hearts=${state.hearts}${giftAuditApplied ? " | Gift Audit: üéÅ -1" : ""}`;

    render();
    checkWinAuto(true);
  }

  function nextDay(){
    if(!state.started){ toast(t('needGame')); return; }
    if(state.locked) return;

    setUndo();

    state.day += 1;
    state.presentGainedToday = false;

    state.tie = "no";
    state.banished = null;
    state.revealSide = "Good";
    state.wrongBanishToday = false;
    state.grinchBanishedToday = false;
    state.spiritCanceledWrong = false;

    state.mayorLastProt = state.mayorProt.slice();
    state.mayorProt = [null,null];
    state.mayorSaved = false;

    state.currentEvent = null;
    state.eventApplied = false;
    state.eventResult = "none";

    state.barkActive = false;
    state.barkResolved = false;
    state.rumorActive = false;
    state.rumorText = "";
    state._lastStealSuccess = false;

    addLog(lang==="ru" ? `–ù–∞—Å—Ç—É–ø–∞–µ—Ç Day ${state.day}.` : `Day ${state.day} begins.`);
    setActiveStep(2);
    render();
  }

  // ---------- Win logic ----------
  function checkWinAuto(isEOD=false){
    if(!state.started) return null;

    if(state.hearts >= 8){
      return endGame("Whoville wins", lang==="ru" ? "Hearts –¥–æ—Å—Ç–∏–≥–ª–∏ 8." : "Hearts reached 8.");
    }
    if(state.presents <= 0){
      return endGame("Grinch wins", lang==="ru" ? "Presents —É–ø–∞–ª–∏ –¥–æ 0." : "Presents dropped to 0.");
    }

    const grinchBanished = (() => {
      if(state.rolesMode === "known"){
        const idx = findRoleIndex("Grinch");
        return (idx!==null) ? !state.players[idx].alive : false;
      }
      return !!state.grinchBanishedToday;
    })();

    if(grinchBanished && state.presents >= 6){
      return endGame("Whoville wins", lang==="ru"
        ? "Grinch –∏–∑–≥–Ω–∞–Ω, –∞ Presents ‚â• 6."
        : "Grinch was banished and Presents ‚â• 6.");
    }

    if(isEOD && state.day >= 6 && state.presents <= 3){
      return endGame("Grinch wins", lang==="ru"
        ? "–ö–æ–Ω–µ—Ü Day 6 –∏ Presents ‚â§ 3."
        : "End of Day 6 and Presents ‚â§ 3.");
    }

    return null;
  }

  function endGame(title, reason){
    state.locked = true;
    $('winTitle').textContent = title;
    $('winReason').textContent = reason + ` (üéÅ=${state.presents}, ‚ù§Ô∏è=${state.hearts}, Day=${state.day})`;
    $('winModal').classList.add('show');
    addLog(`${title}. ${reason}`);
    saveState();
    render();
  }

  // ---------- Export log ----------
  function exportLog(){
    const content = state.log.slice().reverse().join("\n");
    const blob = new Blob([content], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `grinch-mafia-log-day${state.day}.txt`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ---------- Reset ----------
  function resetAll(){
    timerStop();
    localStorage.removeItem(LS_KEY);
    localStorage.removeItem(LS_KEY + ":lang");
    state = DEFAULT_STATE();
    lang = getLang();
    timerSet("07:00", "Discussion");
    render();
  }

  // ---------- Confirm on refresh/close (accidental) ----------
  function hasUnsavedGame(){
    return !!(state && state.started && !state.locked);
  }
  window.addEventListener("beforeunload", (e) => {
    if(!hasUnsavedGame()) return;
    e.preventDefault();
    e.returnValue = "";
  });

  // ---------- Events wiring ----------
  $('btnLang').addEventListener('click', ()=>{
    lang = (lang==="ru") ? "en" : "ru";
    localStorage.setItem(LS_KEY + ":lang", lang);
    render();
  });

  $('btnExport').addEventListener('click', exportLog);

  $('btnReset').addEventListener('click', ()=>{
    const msg = (lang==="ru")
      ? "–°–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É? –í—Å—ë —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –ª–æ–≥ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã."
      : "Reset the game? All current state and log will be deleted.";
    if(confirm(msg)) resetAll();
  });

  $('btnNewGame2').addEventListener('click', ()=>{
    const msg = (lang==="ru")
      ? "–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É? –¢–µ–∫—É—â–∞—è –ø–∞—Ä—Ç–∏—è –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞."
      : "Start a new game? Current game will be deleted.";
    if(confirm(msg)) resetAll();
  });

  $('btnUndo').addEventListener('click', doUndo);

  $('btnInit').addEventListener('click', ()=>{
    $('setupWarn').classList.remove('show');
    initGame();
  });
  $('btnAutoRoles').addEventListener('click', autoAssignRoles);
  $('btnClearRoles').addEventListener('click', clearRoles);

  $('rolesMode').addEventListener('change', ()=>{
    setUndo();
    state.rolesMode = $('rolesMode').value;
    render();
  });

  // Step nav
  $('s1Next').addEventListener('click', ()=> setActiveStep(2));
  $('s2Prev').addEventListener('click', ()=> setActiveStep(1));
  $('s2Next').addEventListener('click', ()=> setActiveStep(3));
  $('s3Prev').addEventListener('click', ()=> setActiveStep(2));
  $('s3Next').addEventListener('click', ()=> setActiveStep(4));
  $('s4Prev').addEventListener('click', ()=> setActiveStep(3));
  $('s4Next').addEventListener('click', ()=> setActiveStep(5));
  $('s5Prev').addEventListener('click', ()=> setActiveStep(4));
  $('s5Next').addEventListener('click', ()=> setActiveStep(6));
  $('s6Prev').addEventListener('click', ()=> setActiveStep(5));
  $('s6Next').addEventListener('click', ()=> setActiveStep(7));
  $('s7Prev').addEventListener('click', ()=> setActiveStep(6));

  $('btnResolveNight').addEventListener('click', resolveNight);
  $('btnMaxSwitch').addEventListener('click', maxSwitch);

  $('btnNewRumor').addEventListener('click', newRumor);
  $('btnBarkSuccess').addEventListener('click', barkSuccess);
  $('btnBarkFail').addEventListener('click', barkFail);
  $('btnSetBarkTimer').addEventListener('click', ()=> timerSet("00:30", "Bark"));

  $('btnDrawEvent').addEventListener('click', ()=> drawEvent(false));
  $('btnRerollEvent').addEventListener('click', rerollEvent);
  $('btnApplyEvent').addEventListener('click', applyEvent);

  $('btnSaveMayor').addEventListener('click', saveMayor);
  $('btnSetDiscussTimer').addEventListener('click', ()=> timerSet("07:00", "Discussion"));

  $('btnCindyKindness').addEventListener('click', cindyKindness);

  $('btnSetTieTimer').addEventListener('click', ()=> timerSet("01:00", "Tie"));
  $('btnApplyVote').addEventListener('click', applyVote);

  $('btnUseSpirit').addEventListener('click', useSpiritBonus);

  $('btnApplyEOD').addEventListener('click', applyEOD);
  $('btnNextDay').addEventListener('click', nextDay);

  $('btnWinCheck').addEventListener('click', ()=> {
    const res = checkWinAuto(false);
    if(!res && !state.locked) toast(t('winNone'));
  });

  // Timer buttons
  $('tStart').addEventListener('click', ()=> timerStart());
  $('tPause').addEventListener('click', ()=> timerStop());
  $('tReset').addEventListener('click', ()=> timerReset());
  $('timerInput').addEventListener('change', ()=>{
    const v = $('timerInput').value;
    const sec = parseMMSS(v);
    if(sec===null) {
      toast("mm:ss");
      $('timerInput').value = mmss(timer.total);
      return;
    }
    timerSet(v, timer.mode);
  });

  // Presets
  $('presetDiscuss').addEventListener('click', ()=> timerSet("07:00", "Discussion"));
  $('presetBark').addEventListener('click', ()=> timerSet("00:30", "Bark"));
  $('presetTie').addEventListener('click', ()=> timerSet("01:00", "Tie"));
  $('preset60').addEventListener('click', ()=> timerSet("01:00", "1 min"));
  $('preset2m').addEventListener('click', ()=> timerSet("02:00", "2 min"));
  $('preset5m').addEventListener('click', ()=> timerSet("05:00", "5 min"));

  // Win modal
  $('btnCloseWin').addEventListener('click', ()=> $('winModal').classList.remove('show'));
  $('btnHardStop').addEventListener('click', ()=>{
    setUndo();
    state.locked = true;
    addLog(lang==="ru" ? "–ò–≥—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ (UI –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω)." : "Game stopped (UI locked).");
    saveState();
    render();
    $('winModal').classList.remove('show');
  });

  // Initial render + restore
  lang = getLang();
  timerSet("07:00", "Discussion");
  render();
})();
</script>
</body>
</html>
